
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Documentation for the roughness python package.">
      
      
        <meta name="author" content="Christian Tai Udovicic">
      
      
        <link rel="canonical" href="https://nau-pixel.github.io/roughness/reference/make_los_table/">
      
      
        <link rel="prev" href="../m3_correction/">
      
      
        <link rel="next" href="../plotting/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.2, mkdocs-material-9.2.1">
    
    
      
        <title>make_los_table - Roughness</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.0e669242.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#make_los_table" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Roughness" class="md-header__button md-logo" aria-label="Roughness" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Roughness
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              make_los_table
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/NAU-PIXEL/roughness" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    NAU-PIXEL/roughness
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../getting_started/" class="md-tabs__link">
          
  
  User Guide

        </a>
      </li>
    
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../about/" class="md-tabs__link">
        
  
    
  
  About

      </a>
    </li>
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../classes/" class="md-tabs__link">
          
  
  Code Reference

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Roughness" class="md-nav__button md-logo" aria-label="Roughness" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Roughness
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/NAU-PIXEL/roughness" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    NAU-PIXEL/roughness
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    User Guide
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            User Guide
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../getting_started/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Getting Started
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../shadow_tables/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Shadow table
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../rough_emission/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Rough Emission
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../about/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    About
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Code Reference
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Code Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../classes/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    classes
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../diviner/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    diviner
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../emission/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    emission
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../helpers/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    helpers
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../m3_correction/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    m3_correction
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    make_los_table
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    make_los_table
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#make_los_table" class="md-nav__link">
    make_los_table
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#make_los_table.bin_slope_azim" class="md-nav__link">
    bin_slope_azim()
  </a>
  
    <nav class="md-nav" aria-label="bin_slope_azim()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#make_los_table.bin_slope_azim--parameters" class="md-nav__link">
    Parameters
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#make_los_table.bin_slope_azim--return" class="md-nav__link">
    Return
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#make_los_table.buffered_raytrace" class="md-nav__link">
    buffered_raytrace()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#make_los_table.get_dem_los_buffer" class="md-nav__link">
    get_dem_los_buffer()
  </a>
  
    <nav class="md-nav" aria-label="get_dem_los_buffer()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#make_los_table.get_dem_los_buffer--parameters" class="md-nav__link">
    Parameters
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#make_los_table.get_dem_los_buffer--return" class="md-nav__link">
    Return
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#make_los_table.get_rms" class="md-nav__link">
    get_rms()
  </a>
  
    <nav class="md-nav" aria-label="get_rms()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#make_los_table.get_rms--parameters" class="md-nav__link">
    Parameters
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#make_los_table.get_rms--returns" class="md-nav__link">
    Returns
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#make_los_table.get_slope_aspect" class="md-nav__link">
    get_slope_aspect()
  </a>
  
    <nav class="md-nav" aria-label="get_slope_aspect()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#make_los_table.get_slope_aspect--parameters" class="md-nav__link">
    Parameters
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#make_los_table.get_slope_aspect--returns" class="md-nav__link">
    Returns
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#make_los_table.load_zsurf" class="md-nav__link">
    load_zsurf()
  </a>
  
    <nav class="md-nav" aria-label="load_zsurf()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#make_los_table.load_zsurf--parameters" class="md-nav__link">
    Parameters
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#make_los_table.load_zsurf--returns" class="md-nav__link">
    Returns
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#make_los_table.load_zsurf_scale_factors" class="md-nav__link">
    load_zsurf_scale_factors()
  </a>
  
    <nav class="md-nav" aria-label="load_zsurf_scale_factors()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#make_los_table.load_zsurf_scale_factors--parameters" class="md-nav__link">
    Parameters
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#make_los_table.load_zsurf_scale_factors--returns" class="md-nav__link">
    Returns
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#make_los_table.make_conj_sym" class="md-nav__link">
    make_conj_sym()
  </a>
  
    <nav class="md-nav" aria-label="make_conj_sym()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#make_los_table.make_conj_sym--parameters" class="md-nav__link">
    Parameters
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#make_los_table.make_conj_sym--returns" class="md-nav__link">
    Returns
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#make_los_table.make_default_los_table" class="md-nav__link">
    make_default_los_table()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#make_los_table.make_los_table" class="md-nav__link">
    make_los_table()
  </a>
  
    <nav class="md-nav" aria-label="make_los_table()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#make_los_table.make_los_table--parameters" class="md-nav__link">
    Parameters
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#make_los_table.make_los_table--returns" class="md-nav__link">
    Returns
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#make_los_table.make_scale_factors" class="md-nav__link">
    make_scale_factors()
  </a>
  
    <nav class="md-nav" aria-label="make_scale_factors()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#make_los_table.make_scale_factors--parameters" class="md-nav__link">
    Parameters
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#make_los_table.make_scale_factors--returns" class="md-nav__link">
    Returns
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#make_los_table.make_zsurf" class="md-nav__link">
    make_zsurf()
  </a>
  
    <nav class="md-nav" aria-label="make_zsurf()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#make_los_table.make_zsurf--parameters" class="md-nav__link">
    Parameters
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#make_los_table.make_zsurf--returns" class="md-nav__link">
    Returns
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#make_los_table.raytrace" class="md-nav__link">
    raytrace()
  </a>
  
    <nav class="md-nav" aria-label="raytrace()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#make_los_table.raytrace--parameters" class="md-nav__link">
    Parameters
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#make_los_table.raytrace--returns" class="md-nav__link">
    Returns
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#make_los_table.scale_dem" class="md-nav__link">
    scale_dem()
  </a>
  
    <nav class="md-nav" aria-label="scale_dem()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#make_los_table.scale_dem--parameters" class="md-nav__link">
    Parameters
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#make_los_table.scale_dem--returns" class="md-nav__link">
    Returns
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../plotting/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    plotting
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../roughness/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    roughness
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#make_los_table" class="md-nav__link">
    make_los_table
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#make_los_table.bin_slope_azim" class="md-nav__link">
    bin_slope_azim()
  </a>
  
    <nav class="md-nav" aria-label="bin_slope_azim()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#make_los_table.bin_slope_azim--parameters" class="md-nav__link">
    Parameters
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#make_los_table.bin_slope_azim--return" class="md-nav__link">
    Return
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#make_los_table.buffered_raytrace" class="md-nav__link">
    buffered_raytrace()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#make_los_table.get_dem_los_buffer" class="md-nav__link">
    get_dem_los_buffer()
  </a>
  
    <nav class="md-nav" aria-label="get_dem_los_buffer()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#make_los_table.get_dem_los_buffer--parameters" class="md-nav__link">
    Parameters
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#make_los_table.get_dem_los_buffer--return" class="md-nav__link">
    Return
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#make_los_table.get_rms" class="md-nav__link">
    get_rms()
  </a>
  
    <nav class="md-nav" aria-label="get_rms()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#make_los_table.get_rms--parameters" class="md-nav__link">
    Parameters
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#make_los_table.get_rms--returns" class="md-nav__link">
    Returns
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#make_los_table.get_slope_aspect" class="md-nav__link">
    get_slope_aspect()
  </a>
  
    <nav class="md-nav" aria-label="get_slope_aspect()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#make_los_table.get_slope_aspect--parameters" class="md-nav__link">
    Parameters
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#make_los_table.get_slope_aspect--returns" class="md-nav__link">
    Returns
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#make_los_table.load_zsurf" class="md-nav__link">
    load_zsurf()
  </a>
  
    <nav class="md-nav" aria-label="load_zsurf()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#make_los_table.load_zsurf--parameters" class="md-nav__link">
    Parameters
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#make_los_table.load_zsurf--returns" class="md-nav__link">
    Returns
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#make_los_table.load_zsurf_scale_factors" class="md-nav__link">
    load_zsurf_scale_factors()
  </a>
  
    <nav class="md-nav" aria-label="load_zsurf_scale_factors()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#make_los_table.load_zsurf_scale_factors--parameters" class="md-nav__link">
    Parameters
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#make_los_table.load_zsurf_scale_factors--returns" class="md-nav__link">
    Returns
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#make_los_table.make_conj_sym" class="md-nav__link">
    make_conj_sym()
  </a>
  
    <nav class="md-nav" aria-label="make_conj_sym()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#make_los_table.make_conj_sym--parameters" class="md-nav__link">
    Parameters
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#make_los_table.make_conj_sym--returns" class="md-nav__link">
    Returns
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#make_los_table.make_default_los_table" class="md-nav__link">
    make_default_los_table()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#make_los_table.make_los_table" class="md-nav__link">
    make_los_table()
  </a>
  
    <nav class="md-nav" aria-label="make_los_table()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#make_los_table.make_los_table--parameters" class="md-nav__link">
    Parameters
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#make_los_table.make_los_table--returns" class="md-nav__link">
    Returns
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#make_los_table.make_scale_factors" class="md-nav__link">
    make_scale_factors()
  </a>
  
    <nav class="md-nav" aria-label="make_scale_factors()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#make_los_table.make_scale_factors--parameters" class="md-nav__link">
    Parameters
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#make_los_table.make_scale_factors--returns" class="md-nav__link">
    Returns
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#make_los_table.make_zsurf" class="md-nav__link">
    make_zsurf()
  </a>
  
    <nav class="md-nav" aria-label="make_zsurf()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#make_los_table.make_zsurf--parameters" class="md-nav__link">
    Parameters
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#make_los_table.make_zsurf--returns" class="md-nav__link">
    Returns
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#make_los_table.raytrace" class="md-nav__link">
    raytrace()
  </a>
  
    <nav class="md-nav" aria-label="raytrace()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#make_los_table.raytrace--parameters" class="md-nav__link">
    Parameters
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#make_los_table.raytrace--returns" class="md-nav__link">
    Returns
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#make_los_table.scale_dem" class="md-nav__link">
    scale_dem()
  </a>
  
    <nav class="md-nav" aria-label="scale_dem()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#make_los_table.scale_dem--parameters" class="md-nav__link">
    Parameters
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#make_los_table.scale_dem--returns" class="md-nav__link">
    Returns
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


  <h1>make_los_table</h1>

<div class="doc doc-object doc-module">


<a id="make_los_table"></a>
  <div class="doc doc-contents first">
  
      <p>Generate line of sight lookup tables.</p>

  

  <div class="doc doc-children">










<div class="doc doc-object doc-function">



<h2 id="make_los_table.bin_slope_azim" class="doc doc-heading">
<code class="highlight language-python"><span class="n">bin_slope_azim</span><span class="p">(</span><span class="n">az</span><span class="p">,</span> <span class="n">slope</span><span class="p">,</span> <span class="n">az_bins</span><span class="p">,</span> <span class="n">slope_bins</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Return count of facets in each slope, azim bin using 2d histogram.</p>
<h4 id="make_los_table.bin_slope_azim--parameters">Parameters</h4>
<p>slope (1D or 2D arr): Facet slope values.
az (1D or 2D arr): Facet azim values.
slope_bins (1D arr): Bin edges of slopes.
az_bins (1D arr): Bin edges of azims.</p>
<h4 id="make_los_table.bin_slope_azim--return">Return</h4>
<p>counts (2D arr nslope, naz): Counts in each slope/az bin; shape defined by bins.</p>

          <details class="quote">
            <summary>Source code in <code>roughness/make_los_table.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">bin_slope_azim</span><span class="p">(</span><span class="n">az</span><span class="p">,</span> <span class="n">slope</span><span class="p">,</span> <span class="n">az_bins</span><span class="p">,</span> <span class="n">slope_bins</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return count of facets in each slope, azim bin using 2d histogram.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    slope (1D or 2D arr): Facet slope values.</span>
<span class="sd">    az (1D or 2D arr): Facet azim values.</span>
<span class="sd">    slope_bins (1D arr): Bin edges of slopes.</span>
<span class="sd">    az_bins (1D arr): Bin edges of azims.</span>

<span class="sd">    Return</span>
<span class="sd">    ------</span>
<span class="sd">    counts (2D arr nslope, naz): Counts in each slope/az bin; shape defined by bins.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram2d</span><span class="p">(</span><span class="n">slope</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">az</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">bins</span><span class="o">=</span><span class="p">(</span><span class="n">slope_bins</span><span class="p">,</span> <span class="n">az_bins</span><span class="p">))</span>
    <span class="n">counts</span> <span class="o">=</span> <span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>  <span class="c1"># Hist 2D transposes output</span>
    <span class="k">return</span> <span class="n">counts</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="make_los_table.buffered_raytrace" class="doc doc-heading">
<code class="highlight language-python"><span class="n">buffered_raytrace</span><span class="p">(</span><span class="n">dem</span><span class="p">,</span> <span class="n">inc</span><span class="p">,</span> <span class="n">az</span><span class="o">=</span><span class="mi">270</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Return line of sight array for dem, with left portion of dem repeated by
leftbuffer then removed from the output. This is intended to extend a
randomly rough dem to the west to correct for the longest shadow distance
possible in the raytrace (otherwise we undercount shadows).</p>

          <details class="quote">
            <summary>Source code in <code>roughness/make_los_table.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">buffered_raytrace</span><span class="p">(</span><span class="n">dem</span><span class="p">,</span> <span class="n">inc</span><span class="p">,</span> <span class="n">az</span><span class="o">=</span><span class="mi">270</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return line of sight array for dem, with left portion of dem repeated by</span>
<span class="sd">    leftbuffer then removed from the output. This is intended to extend a</span>
<span class="sd">    randomly rough dem to the west to correct for the longest shadow distance</span>
<span class="sd">    possible in the raytrace (otherwise we undercount shadows).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Compute buffer, left of which we may be missing shadows</span>
    <span class="n">buf</span> <span class="o">=</span> <span class="n">get_dem_los_buffer</span><span class="p">(</span><span class="n">dem</span><span class="p">,</span> <span class="n">inc</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">az</span> <span class="o">!=</span> <span class="mi">270</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Az must be 270 for this func. Try normal raytrace()&quot;</span><span class="p">)</span>

    <span class="c1"># Max buffer is dem width (if we need to double the dem, use a bigger one)</span>
    <span class="k">if</span> <span class="n">buf</span> <span class="o">&gt;</span> <span class="n">dem</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Supplied </span><span class="si">{</span><span class="n">dem</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> DEM is too small for raytracing &quot;</span>
            <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;at inc=</span><span class="si">{</span><span class="n">inc</span><span class="si">}</span><span class="s2">. Use a DEM at least &quot;</span>
            <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">buf</span><span class="si">}</span><span class="s2"> pixels or specify smaller inc.&quot;</span>
        <span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="n">los</span> <span class="o">=</span> <span class="n">raytrace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">dem</span><span class="p">[:</span><span class="n">buf</span><span class="p">,</span> <span class="p">:],</span> <span class="n">dem</span><span class="p">)),</span> <span class="n">inc</span><span class="p">,</span> <span class="n">az</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">los</span><span class="p">[</span><span class="n">buf</span><span class="p">:,</span> <span class="p">:]</span>  <span class="c1"># Remove left buffer and retranspose</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="make_los_table.get_dem_los_buffer" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_dem_los_buffer</span><span class="p">(</span><span class="n">dem</span><span class="p">,</span> <span class="n">inc</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Return in_buffer, sections of dem too close to the edge to have shadows.</p>
<p>Since dem is of finite size and illuminated from the West at some inc, some
facets towards the left edge of dem cannot have shadows cast onto them. We
compute the max possible shadow length and exclude pixels within that
length from the western edge of dem.</p>
<h4 id="make_los_table.get_dem_los_buffer--parameters">Parameters</h4>
<p>dem (2D arr): Input DEM to ray trace where values are z-height.
inc (1D arr): Input vector incidence angle (0 is nadir).</p>
<h4 id="make_los_table.get_dem_los_buffer--return">Return</h4>
<p>buffer (int): Number of pixels to exclude from western edge of dem.</p>

          <details class="quote">
            <summary>Source code in <code>roughness/make_los_table.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_dem_los_buffer</span><span class="p">(</span><span class="n">dem</span><span class="p">,</span> <span class="n">inc</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return in_buffer, sections of dem too close to the edge to have shadows.</span>

<span class="sd">    Since dem is of finite size and illuminated from the West at some inc, some</span>
<span class="sd">    facets towards the left edge of dem cannot have shadows cast onto them. We</span>
<span class="sd">    compute the max possible shadow length and exclude pixels within that</span>
<span class="sd">    length from the western edge of dem.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dem (2D arr): Input DEM to ray trace where values are z-height.</span>
<span class="sd">    inc (1D arr): Input vector incidence angle (0 is nadir).</span>

<span class="sd">    Return</span>
<span class="sd">    ------</span>
<span class="sd">    buffer (int): Number of pixels to exclude from western edge of dem.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Find peak-to-peak of DEM (max - min)</span>
    <span class="n">elev_span</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ptp</span><span class="p">(</span><span class="n">dem</span><span class="p">)</span>

    <span class="c1"># Calculate longest shadow for buffer. Round up for good measure</span>
    <span class="n">buffer</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">elev_span</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">inc</span><span class="p">)))</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">buffer</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="make_los_table.get_rms" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_rms</span><span class="p">(</span><span class="n">y</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Compute the root mean square of an array, usually a Y array.</p>
<h4 id="make_los_table.get_rms--parameters">Parameters</h4>
<p>y (vector array): Array of values where the variance needs to be computes.</p>
<h4 id="make_los_table.get_rms--returns">Returns</h4>
<p>RMS (value): The RMS value.</p>

          <details class="quote">
            <summary>Source code in <code>roughness/make_los_table.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_rms</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the root mean square of an array, usually a Y array.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    y (vector array): Array of values where the variance needs to be computes.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    RMS (value): The RMS value.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="o">**</span><span class="mf">2.0</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="make_los_table.get_slope_aspect" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_slope_aspect</span><span class="p">(</span><span class="n">dem</span><span class="p">,</span> <span class="n">get_aspect</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Return the instantaneous slope and aspect (if get_aspect) for dem.</p>
<p>Both values derived using NumPy's gradient method by methods from:</p>
<p>Ritter, Paul. "A vector-based slope and aspect generation algorithm."
Photogrammetric Engineering and Remote Sensing 53, no. 8 (1987): 1109-1111</p>
<h4 id="make_los_table.get_slope_aspect--parameters">Parameters</h4>
<p>dem(height) (2D array): A two dimensional array of elevation data.
get_aspect (bool): Whether to also compute and return aspect (default True)</p>
<h4 id="make_los_table.get_slope_aspect--returns">Returns</h4>
<p>slope (2D array): A two dimensional array of slope data.
aspect (2D array, optional): A two dimensional array of aspect data.</p>

          <details class="quote">
            <summary>Source code in <code>roughness/make_los_table.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_slope_aspect</span><span class="p">(</span><span class="n">dem</span><span class="p">,</span> <span class="n">get_aspect</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the instantaneous slope and aspect (if get_aspect) for dem.</span>

<span class="sd">    Both values derived using NumPy&#39;s gradient method by methods from:</span>

<span class="sd">    Ritter, Paul. &quot;A vector-based slope and aspect generation algorithm.&quot;</span>
<span class="sd">    Photogrammetric Engineering and Remote Sensing 53, no. 8 (1987): 1109-1111</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dem(height) (2D array): A two dimensional array of elevation data.</span>
<span class="sd">    get_aspect (bool): Whether to also compute and return aspect (default True)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    slope (2D array): A two dimensional array of slope data.</span>
<span class="sd">    aspect (2D array, optional): A two dimensional array of aspect data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># We use the gradient function to return the dz_dx and dz_dy.</span>
    <span class="n">dz_dy</span><span class="p">,</span> <span class="n">dz_dx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">dem</span><span class="p">)</span>

    <span class="c1"># Slope is returned in degrees through simple calculation.</span>
    <span class="c1"># No windowing is done (e.g. Horn&#39;s method).</span>
    <span class="n">slope</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dz_dx</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">dz_dy</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span>
    <span class="k">if</span> <span class="n">get_aspect</span><span class="p">:</span>
        <span class="n">aspect</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="o">-</span><span class="n">dz_dy</span><span class="p">,</span> <span class="n">dz_dx</span><span class="p">))</span>
        <span class="c1"># Convert to clockwise about Y and restrict to (0, 360) from North</span>
        <span class="n">aspect</span> <span class="o">=</span> <span class="p">(</span><span class="mi">90</span> <span class="o">+</span> <span class="n">aspect</span><span class="p">)</span> <span class="o">%</span> <span class="mi">360</span>
        <span class="k">return</span> <span class="n">slope</span><span class="p">,</span> <span class="n">aspect</span>
    <span class="k">return</span> <span class="n">slope</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="make_los_table.load_zsurf" class="doc doc-heading">
<code class="highlight language-python"><span class="n">load_zsurf</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">FZSURF</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-cached"><code>cached</code></small>
  </span>

</h2>


  <div class="doc doc-contents ">
  
      <p>Return z surface with self-affine roughness at path.</p>
<h4 id="make_los_table.load_zsurf--parameters">Parameters</h4>
<p>path (optional: str): Path to zsurf numpy array</p>
<h4 id="make_los_table.load_zsurf--returns">Returns</h4>
<p>zsurf (2D array): Artifical z surface with self-affine roughness.</p>

          <details class="quote">
            <summary>Source code in <code>roughness/make_los_table.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@lru_cache</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">load_zsurf</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">FZSURF</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return z surface with self-affine roughness at path.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path (optional: str): Path to zsurf numpy array</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    zsurf (2D array): Artifical z surface with self-affine roughness.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">zsurf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
        <span class="n">zsurf</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">zsurf</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="make_los_table.load_zsurf_scale_factors" class="doc doc-heading">
<code class="highlight language-python"><span class="n">load_zsurf_scale_factors</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">FZ_FACTORS</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-cached"><code>cached</code></small>
  </span>

</h2>


  <div class="doc doc-contents ">
  
      <p>Return scale factors at path.</p>
<h4 id="make_los_table.load_zsurf_scale_factors--parameters">Parameters</h4>
<p>path (optional: str): Path to zsurf numpy array</p>
<h4 id="make_los_table.load_zsurf_scale_factors--returns">Returns</h4>
<p>scale_factors (1D array): : Scale factors for zsurf.</p>

          <details class="quote">
            <summary>Source code in <code>roughness/make_los_table.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@lru_cache</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">load_zsurf_scale_factors</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">FZ_FACTORS</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return scale factors at path.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path (optional: str): Path to zsurf numpy array</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    scale_factors (1D array): : Scale factors for zsurf.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">zsurf_factors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
        <span class="n">zsurf_factors</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">zsurf_factors</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="make_los_table.make_conj_sym" class="doc doc-heading">
<code class="highlight language-python"><span class="n">make_conj_sym</span><span class="p">(</span><span class="n">inarray</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">phase</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Takes square mag/phase arrays and impose conjugate symmetry for ifft.</p>
<h4 id="make_los_table.make_conj_sym--parameters">Parameters</h4>
<p>inarray: Square array that will be fed to ifft.
n: Single axis dimension.
phase: If the input is the phase portion of the complex FFT, set phase = 1.</p>
<h4 id="make_los_table.make_conj_sym--returns">Returns</h4>
<p>out: inarray modified to have conjugate symmetry.</p>

          <details class="quote">
            <summary>Source code in <code>roughness/make_los_table.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">make_conj_sym</span><span class="p">(</span><span class="n">inarray</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">phase</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Takes square mag/phase arrays and impose conjugate symmetry for ifft.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    inarray: Square array that will be fed to ifft.</span>
<span class="sd">    n: Single axis dimension.</span>
<span class="sd">    phase: If the input is the phase portion of the complex FFT, set phase = 1.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    out: inarray modified to have conjugate symmetry.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Copy inarray for manipulation.</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">inarray</span><span class="p">)</span>

    <span class="c1"># Define critical indicies (e.g., DC, Nyquist positions)</span>
    <span class="n">DC</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">Ny</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Set the critical indices to 0.</span>
    <span class="n">out</span><span class="p">[</span><span class="n">DC</span><span class="p">,</span> <span class="n">DC</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">out</span><span class="p">[</span><span class="n">DC</span><span class="p">,</span> <span class="n">Ny</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">out</span><span class="p">[</span><span class="n">Ny</span><span class="p">,</span> <span class="n">Ny</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">out</span><span class="p">[</span><span class="n">Ny</span><span class="p">,</span> <span class="n">DC</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># Perform the Hermitian transpose. If input is phase, transpose is negative.</span>
    <span class="k">if</span> <span class="n">phase</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">Ny</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">n</span><span class="p">,</span> <span class="n">Ny</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">n</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="n">DC</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">Ny</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span>
            <span class="n">out</span><span class="p">[</span><span class="n">DC</span><span class="p">,</span> <span class="n">Ny</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">2</span>
        <span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="n">Ny</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">n</span><span class="p">,</span> <span class="n">DC</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span>
            <span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">Ny</span><span class="p">,</span> <span class="n">DC</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">2</span>
        <span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="n">Ny</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">n</span><span class="p">,</span> <span class="n">Ny</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span>
            <span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">Ny</span><span class="p">,</span> <span class="n">Ny</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">2</span>
        <span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">phase</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">Ny</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">n</span><span class="p">,</span> <span class="n">Ny</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">n</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="n">DC</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">Ny</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span>
            <span class="n">out</span><span class="p">[</span><span class="n">DC</span><span class="p">,</span> <span class="n">Ny</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">2</span>
        <span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="n">Ny</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">n</span><span class="p">,</span> <span class="n">DC</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span>
            <span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">Ny</span><span class="p">,</span> <span class="n">DC</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">2</span>
        <span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="n">Ny</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">n</span><span class="p">,</span> <span class="n">Ny</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span>
            <span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">Ny</span><span class="p">,</span> <span class="n">Ny</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">2</span>
        <span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Return symmetric array.</span>
    <span class="k">return</span> <span class="n">out</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="make_los_table.make_default_los_table" class="doc doc-heading">
<code class="highlight language-python"><span class="n">make_default_los_table</span><span class="p">()</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Return default los table.</p>

          <details class="quote">
            <summary>Source code in <code>roughness/make_los_table.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">make_default_los_table</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return default los table.&quot;&quot;&quot;</span>
    <span class="c1"># Load in the synthetic DEM and scale factors</span>
    <span class="n">zsurf</span> <span class="o">=</span> <span class="n">make_zsurf</span><span class="p">(</span><span class="n">DEMSIZE</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">rmss</span><span class="p">,</span> <span class="n">incs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">RMSS</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">INCS</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">make_los_table</span><span class="p">(</span><span class="n">zsurf</span><span class="p">,</span> <span class="n">rmss</span><span class="p">,</span> <span class="n">incs</span><span class="p">,</span> <span class="n">thresh</span><span class="o">=</span><span class="n">MIN_FACETS</span><span class="p">,</span> <span class="n">fout</span><span class="o">=</span><span class="n">FLOOKUP</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="make_los_table.make_los_table" class="doc doc-heading">
<code class="highlight language-python"><span class="n">make_los_table</span><span class="p">(</span><span class="n">zsurf</span><span class="p">,</span> <span class="n">rmss</span><span class="p">,</span> <span class="n">incs</span><span class="p">,</span> <span class="n">naz</span><span class="o">=</span><span class="mi">36</span><span class="p">,</span> <span class="n">ntheta</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span> <span class="n">thresh</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">az0</span><span class="o">=</span><span class="n">AZ0</span><span class="p">,</span> <span class="n">fout</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Generate line of sight probability table with dims (rms, inc, slope, az).</p>
<p>Tables are generated using raytracing on a synthetic Gaussian surface with
a range of RMS slopes and observed from a range of solar inc angles. Final
los_prob table is binned by facet slope/azimuth:</p>
<ul>
<li>los_prob == 1: All facets in line of sight (i.e. visible / illuminated)</li>
<li>los_prob == 0: No facets in line of sight (i.e. not visible / shadowed)</li>
<li>los_prob == np.nan: Fewer than threshold facets observed in bin</li>
</ul>
<h4 id="make_los_table.make_los_table--parameters">Parameters</h4>
<p>zsurf (n x n arr): Artifical z surface with self-affine roughness.
rmss (arr): RMS slope of surface to raytrace
incs (arr): Solar incidence angles to raytrace [degrees]
naz (int): Number of facet azimuth bins. Default=36
ntheta (int): Number of facet slope bins. Default=45
thresh (int): Min facets in bin to assign probability. Default=1
az0 (float): Raytrace azimuth from north in degrees. Default=270
fout (str): Path to write table with xarray extension (e.g. ".nc").</p>
<h4 id="make_los_table.make_los_table--returns">Returns</h4>
<p>xarray.Dataset with 3 DataArrays:
    total: Total number of facets in bin
    los: Number of facets in line of sight in bin
    prob: Fraction of facets in line of sight in bin (los/total)</p>

          <details class="quote">
            <summary>Source code in <code>roughness/make_los_table.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">make_los_table</span><span class="p">(</span>
    <span class="n">zsurf</span><span class="p">,</span> <span class="n">rmss</span><span class="p">,</span> <span class="n">incs</span><span class="p">,</span> <span class="n">naz</span><span class="o">=</span><span class="mi">36</span><span class="p">,</span> <span class="n">ntheta</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span> <span class="n">thresh</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">az0</span><span class="o">=</span><span class="n">AZ0</span><span class="p">,</span> <span class="n">fout</span><span class="o">=</span><span class="kc">None</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate line of sight probability table with dims (rms, inc, slope, az).</span>

<span class="sd">    Tables are generated using raytracing on a synthetic Gaussian surface with</span>
<span class="sd">    a range of RMS slopes and observed from a range of solar inc angles. Final</span>
<span class="sd">    los_prob table is binned by facet slope/azimuth:</span>

<span class="sd">    - los_prob == 1: All facets in line of sight (i.e. visible / illuminated)</span>
<span class="sd">    - los_prob == 0: No facets in line of sight (i.e. not visible / shadowed)</span>
<span class="sd">    - los_prob == np.nan: Fewer than threshold facets observed in bin</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    zsurf (n x n arr): Artifical z surface with self-affine roughness.</span>
<span class="sd">    rmss (arr): RMS slope of surface to raytrace</span>
<span class="sd">    incs (arr): Solar incidence angles to raytrace [degrees]</span>
<span class="sd">    naz (int): Number of facet azimuth bins. Default=36</span>
<span class="sd">    ntheta (int): Number of facet slope bins. Default=45</span>
<span class="sd">    thresh (int): Min facets in bin to assign probability. Default=1</span>
<span class="sd">    az0 (float): Raytrace azimuth from north in degrees. Default=270</span>
<span class="sd">    fout (str): Path to write table with xarray extension (e.g. &quot;.nc&quot;).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    xarray.Dataset with 3 DataArrays:</span>
<span class="sd">        total: Total number of facets in bin</span>
<span class="sd">        los: Number of facets in line of sight in bin</span>
<span class="sd">        prob: Fraction of facets in line of sight in bin (los/total)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">thresh</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Thresh must be &gt;= 1 to assign probability&quot;</span><span class="p">)</span>
    <span class="c1"># Get line of sight lookup coordinate arrays</span>
    <span class="n">azbins</span><span class="p">,</span> <span class="n">slopebins</span> <span class="o">=</span> <span class="n">rh</span><span class="o">.</span><span class="n">get_facet_bins</span><span class="p">(</span><span class="n">naz</span><span class="p">,</span> <span class="n">ntheta</span><span class="p">)</span>

    <span class="c1"># Load or compute scale factors</span>
    <span class="c1"># TODO: scale factors should be computed and associated with zsurf</span>
    <span class="k">if</span> <span class="n">fout</span> <span class="o">==</span> <span class="n">FLOOKUP</span><span class="p">:</span>
        <span class="n">factors</span> <span class="o">=</span> <span class="n">make_scale_factors</span><span class="p">(</span><span class="n">zsurf</span><span class="p">,</span> <span class="n">rmss</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">fout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">f_sf</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">fout</span><span class="p">)</span><span class="o">.</span><span class="n">stem</span> <span class="o">+</span> <span class="s2">&quot;_scale_factors.npy&quot;</span>
        <span class="n">factors</span> <span class="o">=</span> <span class="n">make_scale_factors</span><span class="p">(</span><span class="n">zsurf</span><span class="p">,</span> <span class="n">rmss</span><span class="p">,</span> <span class="n">fout</span><span class="o">=</span><span class="n">f_sf</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">factors</span> <span class="o">=</span> <span class="n">make_scale_factors</span><span class="p">(</span><span class="n">zsurf</span><span class="p">,</span> <span class="n">rmss</span><span class="p">)</span>

    <span class="c1"># Init total and line of sight facet arrays with nodata value</span>
    <span class="c1"># Dtype int since total and los facets are counts</span>
    <span class="n">tot_facets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">rmss</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">incs</span><span class="p">),</span> <span class="n">naz</span><span class="p">,</span> <span class="n">ntheta</span><span class="p">),</span> <span class="o">-</span><span class="mi">999</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">los_facets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">tot_facets</span><span class="p">)</span>

    <span class="c1"># Rms=0 is flat and inc=0 is nadir (all los), inc=90 is horizon (no los)</span>
    <span class="c1"># Skip raytracing these and handle below</span>
    <span class="n">rmss_sub</span> <span class="o">=</span> <span class="n">rmss</span><span class="p">[</span><span class="n">rmss</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">incs_sub</span> <span class="o">=</span> <span class="n">incs</span><span class="p">[(</span><span class="n">incs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">incs</span> <span class="o">&lt;</span> <span class="mi">90</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">r</span><span class="p">,</span> <span class="n">rms</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rmss_sub</span><span class="p">):</span>
        <span class="c1"># Scale the dem to the prescirbed RMS slope and get slope, azim arrays</span>
        <span class="n">dem</span> <span class="o">=</span> <span class="n">scale_dem</span><span class="p">(</span><span class="n">zsurf</span><span class="p">,</span> <span class="n">rms</span><span class="p">,</span> <span class="n">factors</span><span class="p">,</span> <span class="n">rmss</span><span class="p">)</span>
        <span class="n">slope</span><span class="p">,</span> <span class="n">azim</span> <span class="o">=</span> <span class="n">get_slope_aspect</span><span class="p">(</span><span class="n">dem</span><span class="p">)</span>
        <span class="n">azim</span> <span class="o">=</span> <span class="p">(</span><span class="n">azim</span> <span class="o">+</span> <span class="mi">270</span><span class="p">)</span> <span class="o">%</span> <span class="mi">360</span>  <span class="c1"># TODO: cludge, raytrace is rotating az</span>

        <span class="c1"># Get binned counts of total facets in dem (doesn&#39;t change with inc)</span>
        <span class="n">tot_facets</span><span class="p">[</span><span class="n">r</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">bin_slope_azim</span><span class="p">(</span><span class="n">azim</span><span class="p">,</span> <span class="n">slope</span><span class="p">,</span> <span class="n">azbins</span><span class="p">,</span> <span class="n">slopebins</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">inc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">incs_sub</span><span class="p">):</span>
            <span class="c1"># Run ray trace to compute dem facets in line of sight</span>
            <span class="c1"># Buffered extends dem if needed to correct for longest shadow</span>
            <span class="n">los</span> <span class="o">=</span> <span class="n">buffered_raytrace</span><span class="p">(</span><span class="n">dem</span><span class="p">,</span> <span class="n">inc</span><span class="p">,</span> <span class="n">az0</span><span class="p">)</span>

            <span class="c1"># Get binned counts of facets in los</span>
            <span class="n">los_facets</span><span class="p">[</span><span class="n">r</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">bin_slope_azim</span><span class="p">(</span>
                <span class="n">azim</span><span class="p">[</span><span class="n">los</span><span class="p">],</span> <span class="n">slope</span><span class="p">[</span><span class="n">los</span><span class="p">],</span> <span class="n">azbins</span><span class="p">,</span> <span class="n">slopebins</span>
            <span class="p">)</span>

            <span class="c1"># Report progress</span>
            <span class="n">ni</span><span class="p">,</span> <span class="n">nr</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">incs_sub</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">rmss_sub</span><span class="p">)</span>
            <span class="n">ppct</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="n">ni</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">ni</span> <span class="o">*</span> <span class="n">nr</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
            <span class="n">pbar</span> <span class="o">=</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">ppct</span> <span class="o">//</span> <span class="mi">5</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Raytracing [</span><span class="si">{</span><span class="n">pbar</span><span class="si">:</span><span class="s2">20s</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">ppct</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Generating lineofsight lookup table...&quot;</span><span class="p">)</span>

    <span class="c1"># Setting inc=0 to 1 and inc=90 to 0 smooths interpolation of los_prob</span>
    <span class="n">inc_0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">incs</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">los_facets</span><span class="p">[:,</span> <span class="n">inc_0</span><span class="p">]</span> <span class="o">=</span> <span class="n">tot_facets</span><span class="p">[:,</span> <span class="n">inc_0</span><span class="p">]</span>
    <span class="n">los_facets</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">incs</span> <span class="o">==</span> <span class="mi">90</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># Set bins with fewer than threshold facets to nodata (prevents div 0)</span>
    <span class="n">tot_facets</span><span class="p">[</span><span class="n">tot_facets</span> <span class="o">&lt;</span> <span class="n">thresh</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">999</span>

    <span class="c1"># Compute los_prob: fraction of facets in lineofsight / total facets in bin</span>
    <span class="n">los_prob</span> <span class="o">=</span> <span class="n">los_facets</span> <span class="o">/</span> <span class="n">tot_facets</span>

    <span class="c1"># Clean up nodata values and make consistent across all lookups</span>
    <span class="n">nodata</span> <span class="o">=</span> <span class="p">(</span><span class="n">tot_facets</span> <span class="o">==</span> <span class="o">-</span><span class="mi">999</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">los_facets</span> <span class="o">==</span> <span class="o">-</span><span class="mi">999</span><span class="p">)</span>

    <span class="c1"># Clean up jagged edges caused by bin count at theta being close to thresh</span>
    <span class="c1"># If any az bin for a given theta slice is nan, set all az at theta to nan</span>
    <span class="n">rms_nan</span><span class="p">,</span> <span class="n">inc_nan</span><span class="p">,</span> <span class="n">theta_nan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">nodata</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">tot_facets</span><span class="p">[</span><span class="n">rms_nan</span><span class="p">,</span> <span class="n">inc_nan</span><span class="p">,</span> <span class="p">:,</span> <span class="n">theta_nan</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">999</span>
    <span class="n">los_facets</span><span class="p">[</span><span class="n">rms_nan</span><span class="p">,</span> <span class="n">inc_nan</span><span class="p">,</span> <span class="p">:,</span> <span class="n">theta_nan</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">999</span>
    <span class="n">los_prob</span><span class="p">[</span><span class="n">rms_nan</span><span class="p">,</span> <span class="n">inc_nan</span><span class="p">,</span> <span class="p">:,</span> <span class="n">theta_nan</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">999</span>

    <span class="c1"># Setting rms=0 (flat surface) to 1 smooths interpolation of los_prob</span>
    <span class="n">rms_0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">rmss</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">tot_facets</span><span class="p">[</span><span class="n">rms_0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># One facet at each az in 1st slope bin</span>
    <span class="n">los_facets</span><span class="p">[</span><span class="n">rms_0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># Each flat facet is in los</span>
    <span class="n">los_prob</span><span class="p">[</span><span class="n">rms_0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># Each flat facet has 100% chance of los</span>

    <span class="c1"># Convert lookups to xarray</span>
    <span class="n">lookups</span> <span class="o">=</span> <span class="p">(</span><span class="n">tot_facets</span><span class="p">,</span> <span class="n">los_facets</span><span class="p">,</span> <span class="n">los_prob</span><span class="p">)</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">rh</span><span class="o">.</span><span class="n">lookup2xarray</span><span class="p">(</span><span class="n">lookups</span><span class="p">,</span> <span class="n">rmss</span><span class="p">,</span> <span class="n">incs</span><span class="p">,</span> <span class="n">nodata</span><span class="o">=-</span><span class="mi">999</span><span class="p">)</span>
    <span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Roughness line of sight lookup DataSet.&quot;</span>
    <span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">VERSION</span>
    <span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;demsize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">zsurf</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;threshold&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">thresh</span>
    <span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;az0&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">az0</span>

    <span class="k">if</span> <span class="n">fout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ds</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="n">fout</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">PermissionError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">fout</span> <span class="o">=</span> <span class="n">fout</span> <span class="o">+</span> <span class="s2">&quot;.tmp&quot;</span>
            <span class="n">ds</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="n">fout</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Wrote </span><span class="si">{</span><span class="n">fout</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ds</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="make_los_table.make_scale_factors" class="doc doc-heading">
<code class="highlight language-python"><span class="n">make_scale_factors</span><span class="p">(</span><span class="n">zsurf</span><span class="p">,</span> <span class="n">rms_arr</span><span class="p">,</span> <span class="n">write</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fout</span><span class="o">=</span><span class="n">FZ_FACTORS</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Determine scale factors that produce rms_arr slopes from zsurf.</p>
<p>Computes RMS slope of zsurf at several multiplicative scale factors, then
interpolates to find scale_factors at desired rms_arr values.</p>
<h4 id="make_los_table.make_scale_factors--parameters">Parameters</h4>
<p>zsurf (n x n arr): Artifical z surface with self-affine roughness.
rms_arr (arr): Array of RMS values to scale zsurf to (max 80 degrees).
write (bool): Write out scale factors to file.
fout (str): Path to write scale factors.
default (bool): Use default scale factors if they exist.</p>
<h4 id="make_los_table.make_scale_factors--returns">Returns</h4>
<p>scale_factors (arr): Factors to scale zsurf by to get each rms_arr value.</p>

          <details class="quote">
            <summary>Source code in <code>roughness/make_los_table.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">make_scale_factors</span><span class="p">(</span>
    <span class="n">zsurf</span><span class="p">,</span> <span class="n">rms_arr</span><span class="p">,</span> <span class="n">write</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fout</span><span class="o">=</span><span class="n">FZ_FACTORS</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determine scale factors that produce rms_arr slopes from zsurf.</span>

<span class="sd">    Computes RMS slope of zsurf at several multiplicative scale factors, then</span>
<span class="sd">    interpolates to find scale_factors at desired rms_arr values.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    zsurf (n x n arr): Artifical z surface with self-affine roughness.</span>
<span class="sd">    rms_arr (arr): Array of RMS values to scale zsurf to (max 80 degrees).</span>
<span class="sd">    write (bool): Write out scale factors to file.</span>
<span class="sd">    fout (str): Path to write scale factors.</span>
<span class="sd">    default (bool): Use default scale factors if they exist.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    scale_factors (arr): Factors to scale zsurf by to get each rms_arr value.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">default</span><span class="p">:</span>
        <span class="n">fout</span> <span class="o">=</span> <span class="n">rh</span><span class="o">.</span><span class="n">fname_with_demsize</span><span class="p">(</span>
            <span class="n">fout</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">zsurf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">_rmsmax_</span><span class="si">{</span><span class="nb">max</span><span class="p">(</span><span class="n">rms_arr</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="c1"># Try to load scale factors and check they are correct length</span>
        <span class="n">scale_factors</span> <span class="o">=</span> <span class="n">load_zsurf_scale_factors</span><span class="p">(</span><span class="n">fout</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">scale_factors</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">scale_factors</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">rms_arr</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loaded scale_factors from </span><span class="si">{</span><span class="n">fout</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">scale_factors</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Calculating new scale factors...&quot;</span><span class="p">)</span>
    <span class="c1"># Scale factors from 0x to 10x in logspace (~0 to 80 degrees RMS)</span>
    <span class="n">factors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">20</span><span class="p">)])</span>
    <span class="n">rms_derived</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">factors</span><span class="p">)</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># rms=0 is factor=0 so we start at 1</span>
    <span class="c1"># Save RMS slope at each factor, end loop when we exceed max(rms_arr)</span>
    <span class="k">while</span> <span class="n">rms_derived</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="nb">max</span><span class="p">(</span><span class="n">rms_arr</span><span class="p">)</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">factors</span><span class="p">):</span>
        <span class="c1"># Compute z surface * factor and get RMS</span>
        <span class="n">zsurf_new</span> <span class="o">=</span> <span class="n">zsurf</span> <span class="o">*</span> <span class="n">factors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">rms_derived</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_rms</span><span class="p">(</span><span class="n">get_slope_aspect</span><span class="p">(</span><span class="n">zsurf_new</span><span class="p">,</span> <span class="n">get_aspect</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># Interpolate to get the factor at each rms in rms_arr (truncate at last i)</span>
    <span class="n">scale_factors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">rms_arr</span><span class="p">,</span> <span class="n">rms_derived</span><span class="p">[:</span><span class="n">i</span><span class="p">],</span> <span class="n">factors</span><span class="p">[:</span><span class="n">i</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">write</span><span class="p">:</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">fout</span><span class="p">,</span> <span class="n">scale_factors</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Wrote scale_factors to </span><span class="si">{</span><span class="n">fout</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">scale_factors</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="make_los_table.make_zsurf" class="doc doc-heading">
<code class="highlight language-python"><span class="n">make_zsurf</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">H</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">qr</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">fout</span><span class="o">=</span><span class="n">FZSURF</span><span class="p">,</span> <span class="n">write</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Return a synthetic surface with self-affine roughness.
Much of this is detailed in this paper:
Tevis D B Jacobs et al 2017 Surf. Topogr.: Metrol. Prop. 5 013001
https://doi.org/10.1088/2051-672X/aa51f8</p>
<h4 id="make_los_table.make_zsurf--parameters">Parameters</h4>
<p>n: Side length of synthetic surface. Default=10000
H: Hurst exponent.
qr: Rolloff wavelength in units of q (wavevector; 1/m).
fout (str): Path to write z surface (.npy).</p>
<h4 id="make_los_table.make_zsurf--returns">Returns</h4>
<p>zsurf (n x n arr): Artifical z surface with self-affine roughness.</p>

          <details class="quote">
            <summary>Source code in <code>roughness/make_los_table.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">make_zsurf</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">H</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">qr</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">fout</span><span class="o">=</span><span class="n">FZSURF</span><span class="p">,</span> <span class="n">write</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a synthetic surface with self-affine roughness.</span>
<span class="sd">    Much of this is detailed in this paper:</span>
<span class="sd">    Tevis D B Jacobs et al 2017 Surf. Topogr.: Metrol. Prop. 5 013001</span>
<span class="sd">    https://doi.org/10.1088/2051-672X/aa51f8</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    n: Side length of synthetic surface. Default=10000</span>
<span class="sd">    H: Hurst exponent.</span>
<span class="sd">    qr: Rolloff wavelength in units of q (wavevector; 1/m).</span>
<span class="sd">    fout (str): Path to write z surface (.npy).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    zsurf (n x n arr): Artifical z surface with self-affine roughness.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Return zsurf from fout if it exists and is correct size</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">default</span><span class="p">:</span>
        <span class="n">fout</span> <span class="o">=</span> <span class="n">rh</span><span class="o">.</span><span class="n">fname_with_demsize</span><span class="p">(</span><span class="n">fout</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
        <span class="n">zsurf</span> <span class="o">=</span> <span class="n">load_zsurf</span><span class="p">(</span><span class="n">fout</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">zsurf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">zsurf</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loaded zsurf from </span><span class="si">{</span><span class="n">fout</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">zsurf</span>

    <span class="c1"># Make sure the dimensions are even</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Making new z surface...&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">%</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="c1"># Detemine image lengths. This implementation is finite but can be</span>
    <span class="c1"># modified for continuous wavevectors where q-&gt;infinity</span>
    <span class="n">pixelwidth</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">n</span>

    <span class="c1"># Build the 1D wavevector, 1D FFT shift, unwrap to adjust for 2 pi phase.</span>
    <span class="n">q</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">unwrap</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(((</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">n</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span><span class="p">))))</span>
        <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
    <span class="p">)</span> <span class="o">/</span> <span class="n">pixelwidth</span>

    <span class="c1"># Create 2D mesh of the wavevector and convert to polar coordinates.</span>
    <span class="n">qxx</span><span class="p">,</span> <span class="n">qyy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
    <span class="n">rho</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">rh</span><span class="o">.</span><span class="n">cart2pol</span><span class="p">(</span><span class="n">qxx</span><span class="p">,</span> <span class="n">qyy</span><span class="p">)</span>

    <span class="c1"># Make a 2D PSD zeros matrix and fill it with the polar rho values</span>
    <span class="c1"># from the 2D wavevectors. First line account for the rolloff by making it</span>
    <span class="c1"># constant. This also properly accounts for Hurst exponent by raising the</span>
    <span class="c1"># wavevectors to (-2*(H+1))</span>
    <span class="n">Cq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
    <span class="n">Cq</span><span class="p">[</span><span class="n">rho</span> <span class="o">&lt;</span> <span class="n">qr</span><span class="p">]</span> <span class="o">=</span> <span class="n">qr</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">H</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">Cq</span><span class="p">[</span><span class="n">rho</span> <span class="o">&gt;=</span> <span class="n">qr</span><span class="p">]</span> <span class="o">=</span> <span class="n">rho</span><span class="p">[</span><span class="n">rho</span> <span class="o">&gt;=</span> <span class="n">qr</span><span class="p">]</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">H</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

    <span class="c1"># The center of the PSD is the ifft mean. We set this to 0.</span>
    <span class="n">Cq</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">n</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># This section imposes conjugate symmetry for  mag/phase input to ifft</span>
    <span class="n">Bq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Cq</span> <span class="o">/</span> <span class="p">(</span><span class="n">pixelwidth</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">((</span><span class="n">n</span> <span class="o">*</span> <span class="n">n</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))))</span>
    <span class="n">Bq</span> <span class="o">=</span> <span class="n">make_conj_sym</span><span class="p">(</span><span class="n">Bq</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>

    <span class="c1"># Here is where we introduce the randon gaussian portion.</span>
    <span class="n">noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
    <span class="n">Phi</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">noise</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
    <span class="n">Phi</span> <span class="o">=</span> <span class="n">make_conj_sym</span><span class="p">(</span><span class="n">Phi</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">phase</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Now we convert back to cartesian coordinates.</span>
    <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">rh</span><span class="o">.</span><span class="n">pol2cart</span><span class="p">(</span><span class="n">Bq</span><span class="p">,</span> <span class="n">Phi</span><span class="p">)</span>

    <span class="c1"># Time to invert the FFT and generate our topography</span>
    <span class="c1"># Need to allocate an empty complex array similar in size to our Bq.</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">Bq</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;complex128&quot;</span><span class="p">)</span>

    <span class="c1"># NumPy complex arrays allow definition of the real and imaginary components.</span>
    <span class="n">out</span><span class="o">.</span><span class="n">real</span> <span class="o">=</span> <span class="n">a</span>
    <span class="n">out</span><span class="o">.</span><span class="n">imag</span> <span class="o">=</span> <span class="n">b</span>

    <span class="c1"># Call the inverse FFT shift to put our low frequency stuff to the margins.</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifftshift</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

    <span class="c1"># And finally we call the inverse FFT.</span>
    <span class="c1"># Because we went through all that trouble to make the array symmetric this</span>
    <span class="c1"># should return a real, float array and make iFFT run faster.</span>
    <span class="n">zsurf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft2</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

    <span class="c1"># But it won&#39;t do that because of rounding so we call it real if close.</span>
    <span class="n">zsurf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real_if_close</span><span class="p">(</span><span class="n">zsurf</span><span class="p">)</span>

    <span class="c1"># Because we are going to scale to various RMS slopes we want to normalize.</span>
    <span class="n">norm_zsurf</span> <span class="o">=</span> <span class="p">(</span><span class="n">zsurf</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">zsurf</span><span class="p">))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">zsurf</span><span class="p">)</span>

    <span class="c1"># Voila. A real array of height values with self-affine roughness.</span>
    <span class="c1"># Save it!</span>
    <span class="k">if</span> <span class="n">write</span><span class="p">:</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">fout</span><span class="p">,</span> <span class="n">norm_zsurf</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Wrote zsurf to </span><span class="si">{</span><span class="n">fout</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">norm_zsurf</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="make_los_table.raytrace" class="doc doc-heading">
<code class="highlight language-python"><span class="n">raytrace</span><span class="p">(</span><span class="n">dem</span><span class="p">,</span> <span class="n">inc</span><span class="p">,</span> <span class="n">az</span><span class="o">=</span><span class="mi">270</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Return line of sight boolean array of 2D dem viewed from (inc, azim).</p>
<p>Wraps lineofsight raytrace module.</p>
<h4 id="make_los_table.raytrace--parameters">Parameters</h4>
<p>dem (2D arr): Input DEM to ray trace where values are z-height.
inc (1D arr): Input vector incidence angle [0, 90) where 0 is nadir.
az (1D arr): Input vector azimuth angle [0, 360) where 0 is North.</p>
<h4 id="make_los_table.raytrace--returns">Returns</h4>
<p>out (2D bool arr, dem.shape): True - in los; False - not in los</p>

          <details class="quote">
            <summary>Source code in <code>roughness/make_los_table.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">raytrace</span><span class="p">(</span><span class="n">dem</span><span class="p">,</span> <span class="n">inc</span><span class="p">,</span> <span class="n">az</span><span class="o">=</span><span class="mi">270</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return line of sight boolean array of 2D dem viewed from (inc, azim).</span>

<span class="sd">    Wraps lineofsight raytrace module.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dem (2D arr): Input DEM to ray trace where values are z-height.</span>
<span class="sd">    inc (1D arr): Input vector incidence angle [0, 90) where 0 is nadir.</span>
<span class="sd">    az (1D arr): Input vector azimuth angle [0, 360) where 0 is North.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    out (2D bool arr, dem.shape): True - in los; False - not in los</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Make an input array where all values are illuminated</span>
    <span class="n">los</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">dem</span><span class="p">)</span>  <span class="c1"># , order=&#39;F&#39;)</span>
    <span class="n">cols</span><span class="p">,</span> <span class="n">rows</span> <span class="o">=</span> <span class="n">los</span><span class="o">.</span><span class="n">shape</span>
    <span class="c1"># If inc == 0 all illuminated, if inc &gt;= 90 none illuminated</span>
    <span class="k">if</span> <span class="n">inc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">elif</span> <span class="n">inc</span> <span class="o">&gt;=</span> <span class="mi">90</span><span class="p">:</span>
        <span class="n">los</span> <span class="o">*=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Passing inputs to the fortran module</span>
        <span class="c1"># TODO: weird transpose passing back/forth from fortran (works for now)</span>
        <span class="n">los</span> <span class="o">=</span> <span class="n">lineofsight</span><span class="o">.</span><span class="n">lineofsight</span><span class="p">(</span>
            <span class="n">dem</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="s2">&quot;F&quot;</span><span class="p">),</span> <span class="n">inc</span><span class="p">,</span> <span class="n">az</span><span class="p">,</span> <span class="n">los</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">rows</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">los</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="make_los_table.scale_dem" class="doc doc-heading">
<code class="highlight language-python"><span class="n">scale_dem</span><span class="p">(</span><span class="n">dem</span><span class="p">,</span> <span class="n">rms</span><span class="p">,</span> <span class="n">scale_factors</span><span class="p">,</span> <span class="n">rmss</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Scale a DEM by a set of scale factors.</p>
<h4 id="make_los_table.scale_dem--parameters">Parameters</h4>
<p>dem (n x n arr): DEM to scale.
rms (int): RMS value to scale to.
scale_factors (arr): Factors to scale dem by.
rmss (arr): RMS values corresponding to scale_factors.</p>
<h4 id="make_los_table.scale_dem--returns">Returns</h4>
<p>scaled_dem (n x n arr): DEM scaled to have rms roughness.</p>

          <details class="quote">
            <summary>Source code in <code>roughness/make_los_table.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">scale_dem</span><span class="p">(</span><span class="n">dem</span><span class="p">,</span> <span class="n">rms</span><span class="p">,</span> <span class="n">scale_factors</span><span class="p">,</span> <span class="n">rmss</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Scale a DEM by a set of scale factors.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dem (n x n arr): DEM to scale.</span>
<span class="sd">    rms (int): RMS value to scale to.</span>
<span class="sd">    scale_factors (arr): Factors to scale dem by.</span>
<span class="sd">    rmss (arr): RMS values corresponding to scale_factors.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    scaled_dem (n x n arr): DEM scaled to have rms roughness.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Find the closest scale factor to the desired rms</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">rmss</span> <span class="o">-</span> <span class="n">rms</span><span class="p">))</span>
    <span class="c1"># Scale the dem by the scale factor</span>
    <span class="k">return</span> <span class="n">dem</span> <span class="o">*</span> <span class="n">scale_factors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2023 Christian Tai Udovicic
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
    <a href="https://github.com/nau-pixel" target="_blank" rel="noopener" title="NAU-PIXEL on GitHub" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.instant", "navigation.tabs"], "search": "../../assets/javascripts/workers/search.dfff1995.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.78eede0e.min.js"></script>
      
        <script src="../../docs/javascript/config.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>