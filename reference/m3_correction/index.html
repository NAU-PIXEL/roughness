
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Documentation for the roughness python package.">
      
      
        <meta name="author" content="Christian Tai Udovicic">
      
      
        <link rel="canonical" href="https://nau-pixel.github.io/roughness/reference/m3_correction/">
      
      
        <link rel="prev" href="../helpers/">
      
      
        <link rel="next" href="../make_los_table/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.2, mkdocs-material-9.2.1">
    
    
      
        <title>m3_correction - Roughness</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.0e669242.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#m3_correction" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Roughness" class="md-header__button md-logo" aria-label="Roughness" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Roughness
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              m3_correction
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/NAU-PIXEL/roughness" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    NAU-PIXEL/roughness
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../getting_started/" class="md-tabs__link">
          
  
  User Guide

        </a>
      </li>
    
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../about/" class="md-tabs__link">
        
  
    
  
  About

      </a>
    </li>
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../classes/" class="md-tabs__link">
          
  
  Code Reference

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Roughness" class="md-nav__button md-logo" aria-label="Roughness" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Roughness
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/NAU-PIXEL/roughness" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    NAU-PIXEL/roughness
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    User Guide
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            User Guide
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../getting_started/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Getting Started
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../shadow_tables/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Shadow table
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../rough_emission/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Rough Emission
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../about/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    About
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Code Reference
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Code Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../classes/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    classes
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../diviner/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    diviner
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../emission/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    emission
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../helpers/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    helpers
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    m3_correction
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    m3_correction
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#m3_correction" class="md-nav__link">
    m3_correction
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.assign_loc" class="md-nav__link">
    assign_loc()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.bands2wls" class="md-nav__link">
    bands2wls()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.contin_remove" class="md-nav__link">
    contin_remove()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.emission_xr_helper" class="md-nav__link">
    emission_xr_helper()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.ext2window" class="md-nav__link">
    ext2window()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.furnsh_kernels" class="md-nav__link">
    furnsh_kernels()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.get_albedo_feng" class="md-nav__link">
    get_albedo_feng()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.get_avg_spec" class="md-nav__link">
    get_avg_spec()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.get_avg_sun_inc_az" class="md-nav__link">
    get_avg_sun_inc_az()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.get_dem_geotiff" class="md-nav__link">
    get_dem_geotiff()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.get_dem_xr" class="md-nav__link">
    get_dem_xr()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.get_emission_xr" class="md-nav__link">
    get_emission_xr()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.get_ls_spice" class="md-nav__link">
    get_ls_spice()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.get_m3_date" class="md-nav__link">
    get_m3_date()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.get_m3_directory" class="md-nav__link">
    get_m3_directory()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.get_m3_geom" class="md-nav__link">
    get_m3_geom()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.get_m3_geom_xr" class="md-nav__link">
    get_m3_geom_xr()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.get_m3_headers" class="md-nav__link">
    get_m3_headers()
  </a>
  
    <nav class="md-nav" aria-label="get_m3_headers()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#m3_correction.get_m3_headers--see-also" class="md-nav__link">
    See Also
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#m3_correction.get_m3_headers--examples" class="md-nav__link">
    Examples
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.get_m3_op" class="md-nav__link">
    get_m3_op()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.get_m3_res" class="md-nav__link">
    get_m3_res()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.get_m3_tloc" class="md-nav__link">
    get_m3_tloc()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.get_m3_warm" class="md-nav__link">
    get_m3_warm()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.get_m3_wls" class="md-nav__link">
    get_m3_wls()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.get_m3albedo" class="md-nav__link">
    get_m3albedo()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.get_m3photom" class="md-nav__link">
    get_m3photom()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.get_m3xr" class="md-nav__link">
    get_m3xr()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.get_photom" class="md-nav__link">
    get_photom()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.get_photom_xr" class="md-nav__link">
    get_photom_xr()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.get_polish" class="md-nav__link">
    get_polish()
  </a>
  
    <nav class="md-nav" aria-label="get_polish()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#m3_correction.get_polish--returns" class="md-nav__link">
    Returns
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.get_polish_xr" class="md-nav__link">
    get_polish_xr()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.get_solar_dist" class="md-nav__link">
    get_solar_dist()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.get_solar_irradiance_xr" class="md-nav__link">
    get_solar_irradiance_xr()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.get_solar_spectrum" class="md-nav__link">
    get_solar_spectrum()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.get_solar_spectrum_xr" class="md-nav__link">
    get_solar_spectrum_xr()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.get_spec" class="md-nav__link">
    get_spec()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.get_tloc_range_spice" class="md-nav__link">
    get_tloc_range_spice()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.ibd3um" class="md-nav__link">
    ibd3um()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.index_m3xoak" class="md-nav__link">
    index_m3xoak()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.is_targeted" class="md-nav__link">
    is_targeted()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.lin_contin" class="md-nav__link">
    lin_contin()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.lon180" class="md-nav__link">
    lon180()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.lon360" class="md-nav__link">
    lon360()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.lst2tloc" class="md-nav__link">
    lst2tloc()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.m3_refl" class="md-nav__link">
    m3_refl()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.m3_size_est" class="md-nav__link">
    m3_size_est()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.m3_wl_to_ind" class="md-nav__link">
    m3_wl_to_ind()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.m3basename2utc" class="md-nav__link">
    m3basename2utc()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.map_blocks" class="md-nav__link">
    map_blocks()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.mpp2ppd" class="md-nav__link">
    mpp2ppd()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.parse_envi_header" class="md-nav__link">
    parse_envi_header()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.read_albedo_map_feng" class="md-nav__link">
    read_albedo_map_feng()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.read_m3_geotiff" class="md-nav__link">
    read_m3_geotiff()
  </a>
  
    <nav class="md-nav" aria-label="read_m3_geotiff()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#m3_correction.read_m3_geotiff--parameters" class="md-nav__link">
    Parameters
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.read_m3_geotiff_ext" class="md-nav__link">
    read_m3_geotiff_ext()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.read_m3_image" class="md-nav__link">
    read_m3_image()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.read_m3_rois" class="md-nav__link">
    read_m3_rois()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.readm3geotif_xr" class="md-nav__link">
    readm3geotif_xr()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.rio2xy" class="md-nav__link">
    rio2xy()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.rio_pad" class="md-nav__link">
    rio_pad()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.sel_m3xoak" class="md-nav__link">
    sel_m3xoak()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.sel_nearest" class="md-nav__link">
    sel_nearest()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.subset_m3xr_ext" class="md-nav__link">
    subset_m3xr_ext()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.utc2lsmoon" class="md-nav__link">
    utc2lsmoon()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.utc2lstmoon" class="md-nav__link">
    utc2lstmoon()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.utc2sdistmoon" class="md-nav__link">
    utc2sdistmoon()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.wl_to_ind" class="md-nav__link">
    wl_to_ind()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.xy2np" class="md-nav__link">
    xy2np()
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../make_los_table/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    make_los_table
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../plotting/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    plotting
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../roughness/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    roughness
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#m3_correction" class="md-nav__link">
    m3_correction
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.assign_loc" class="md-nav__link">
    assign_loc()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.bands2wls" class="md-nav__link">
    bands2wls()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.contin_remove" class="md-nav__link">
    contin_remove()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.emission_xr_helper" class="md-nav__link">
    emission_xr_helper()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.ext2window" class="md-nav__link">
    ext2window()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.furnsh_kernels" class="md-nav__link">
    furnsh_kernels()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.get_albedo_feng" class="md-nav__link">
    get_albedo_feng()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.get_avg_spec" class="md-nav__link">
    get_avg_spec()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.get_avg_sun_inc_az" class="md-nav__link">
    get_avg_sun_inc_az()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.get_dem_geotiff" class="md-nav__link">
    get_dem_geotiff()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.get_dem_xr" class="md-nav__link">
    get_dem_xr()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.get_emission_xr" class="md-nav__link">
    get_emission_xr()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.get_ls_spice" class="md-nav__link">
    get_ls_spice()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.get_m3_date" class="md-nav__link">
    get_m3_date()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.get_m3_directory" class="md-nav__link">
    get_m3_directory()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.get_m3_geom" class="md-nav__link">
    get_m3_geom()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.get_m3_geom_xr" class="md-nav__link">
    get_m3_geom_xr()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.get_m3_headers" class="md-nav__link">
    get_m3_headers()
  </a>
  
    <nav class="md-nav" aria-label="get_m3_headers()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#m3_correction.get_m3_headers--see-also" class="md-nav__link">
    See Also
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#m3_correction.get_m3_headers--examples" class="md-nav__link">
    Examples
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.get_m3_op" class="md-nav__link">
    get_m3_op()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.get_m3_res" class="md-nav__link">
    get_m3_res()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.get_m3_tloc" class="md-nav__link">
    get_m3_tloc()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.get_m3_warm" class="md-nav__link">
    get_m3_warm()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.get_m3_wls" class="md-nav__link">
    get_m3_wls()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.get_m3albedo" class="md-nav__link">
    get_m3albedo()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.get_m3photom" class="md-nav__link">
    get_m3photom()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.get_m3xr" class="md-nav__link">
    get_m3xr()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.get_photom" class="md-nav__link">
    get_photom()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.get_photom_xr" class="md-nav__link">
    get_photom_xr()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.get_polish" class="md-nav__link">
    get_polish()
  </a>
  
    <nav class="md-nav" aria-label="get_polish()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#m3_correction.get_polish--returns" class="md-nav__link">
    Returns
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.get_polish_xr" class="md-nav__link">
    get_polish_xr()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.get_solar_dist" class="md-nav__link">
    get_solar_dist()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.get_solar_irradiance_xr" class="md-nav__link">
    get_solar_irradiance_xr()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.get_solar_spectrum" class="md-nav__link">
    get_solar_spectrum()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.get_solar_spectrum_xr" class="md-nav__link">
    get_solar_spectrum_xr()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.get_spec" class="md-nav__link">
    get_spec()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.get_tloc_range_spice" class="md-nav__link">
    get_tloc_range_spice()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.ibd3um" class="md-nav__link">
    ibd3um()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.index_m3xoak" class="md-nav__link">
    index_m3xoak()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.is_targeted" class="md-nav__link">
    is_targeted()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.lin_contin" class="md-nav__link">
    lin_contin()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.lon180" class="md-nav__link">
    lon180()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.lon360" class="md-nav__link">
    lon360()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.lst2tloc" class="md-nav__link">
    lst2tloc()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.m3_refl" class="md-nav__link">
    m3_refl()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.m3_size_est" class="md-nav__link">
    m3_size_est()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.m3_wl_to_ind" class="md-nav__link">
    m3_wl_to_ind()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.m3basename2utc" class="md-nav__link">
    m3basename2utc()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.map_blocks" class="md-nav__link">
    map_blocks()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.mpp2ppd" class="md-nav__link">
    mpp2ppd()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.parse_envi_header" class="md-nav__link">
    parse_envi_header()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.read_albedo_map_feng" class="md-nav__link">
    read_albedo_map_feng()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.read_m3_geotiff" class="md-nav__link">
    read_m3_geotiff()
  </a>
  
    <nav class="md-nav" aria-label="read_m3_geotiff()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#m3_correction.read_m3_geotiff--parameters" class="md-nav__link">
    Parameters
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.read_m3_geotiff_ext" class="md-nav__link">
    read_m3_geotiff_ext()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.read_m3_image" class="md-nav__link">
    read_m3_image()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.read_m3_rois" class="md-nav__link">
    read_m3_rois()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.readm3geotif_xr" class="md-nav__link">
    readm3geotif_xr()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.rio2xy" class="md-nav__link">
    rio2xy()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.rio_pad" class="md-nav__link">
    rio_pad()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.sel_m3xoak" class="md-nav__link">
    sel_m3xoak()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.sel_nearest" class="md-nav__link">
    sel_nearest()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.subset_m3xr_ext" class="md-nav__link">
    subset_m3xr_ext()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.utc2lsmoon" class="md-nav__link">
    utc2lsmoon()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.utc2lstmoon" class="md-nav__link">
    utc2lstmoon()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.utc2sdistmoon" class="md-nav__link">
    utc2sdistmoon()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.wl_to_ind" class="md-nav__link">
    wl_to_ind()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#m3_correction.xy2np" class="md-nav__link">
    xy2np()
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


  <h1>m3_correction</h1>

<div class="doc doc-object doc-module">


<a id="m3_correction"></a>
  <div class="doc doc-contents first">
  
      <p>M3-specific functions for testing</p>

  

  <div class="doc doc-children">










<div class="doc doc-object doc-function">



<h2 id="m3_correction.assign_loc" class="doc doc-heading">
<code class="highlight language-python"><span class="n">assign_loc</span><span class="p">(</span><span class="n">da</span><span class="p">,</span> <span class="n">basename</span><span class="p">,</span> <span class="n">usgs</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Return da with loc backplane assigned as 2D coords of (x, y).</p>

          <details class="quote">
            <summary>Source code in <code>roughness/m3_correction.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">assign_loc</span><span class="p">(</span><span class="n">da</span><span class="p">,</span> <span class="n">basename</span><span class="p">,</span> <span class="n">usgs</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return da with loc backplane assigned as 2D coords of (x, y).&quot;&quot;&quot;</span>
    <span class="n">loc</span> <span class="o">=</span> <span class="n">get_m3xr</span><span class="p">(</span><span class="n">basename</span><span class="p">,</span> <span class="s2">&quot;loc&quot;</span><span class="p">,</span> <span class="n">usgs</span><span class="p">,</span> <span class="n">dask</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">xoak</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">da</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;lat&quot;</span><span class="p">:</span> <span class="p">((</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">),</span> <span class="n">loc</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">band</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">),</span>
            <span class="s2">&quot;lon&quot;</span><span class="p">:</span> <span class="p">((</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">),</span> <span class="n">loc</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">band</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">),</span>
        <span class="p">}</span>
    <span class="p">)</span>
    <span class="n">da</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;floc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">loc</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;fimg&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">da</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="m3_correction.bands2wls" class="doc doc-heading">
<code class="highlight language-python"><span class="n">bands2wls</span><span class="p">(</span><span class="n">da</span><span class="p">,</span> <span class="n">basename</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Return da with M3 wavelength coordinate replacing bands.</p>

          <details class="quote">
            <summary>Source code in <code>roughness/m3_correction.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">bands2wls</span><span class="p">(</span><span class="n">da</span><span class="p">,</span> <span class="n">basename</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return da with M3 wavelength coordinate replacing bands.&quot;&quot;&quot;</span>
    <span class="n">wls</span> <span class="o">=</span> <span class="n">get_m3_wls</span><span class="p">(</span><span class="n">basename</span><span class="p">)</span>
    <span class="n">da</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">da</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">wavelength</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;band&quot;</span><span class="p">,</span> <span class="n">wls</span><span class="p">))</span>
        <span class="o">.</span><span class="n">swap_dims</span><span class="p">({</span><span class="s2">&quot;band&quot;</span><span class="p">:</span> <span class="s2">&quot;wavelength&quot;</span><span class="p">})</span>
        <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;band&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">da</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="m3_correction.contin_remove" class="doc doc-heading">
<code class="highlight language-python"><span class="n">contin_remove</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">wl1</span><span class="o">=</span><span class="mf">2.537</span><span class="p">,</span> <span class="n">wl2</span><span class="o">=</span><span class="mf">2.657</span><span class="p">,</span> <span class="n">divide</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Remove linear continuum fit between wl1 and wl2 from spec.</p>

          <details class="quote">
            <summary>Source code in <code>roughness/m3_correction.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1367</span>
<span class="normal">1368</span>
<span class="normal">1369</span>
<span class="normal">1370</span>
<span class="normal">1371</span>
<span class="normal">1372</span>
<span class="normal">1373</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">contin_remove</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">wl1</span><span class="o">=</span><span class="mf">2.537</span><span class="p">,</span> <span class="n">wl2</span><span class="o">=</span><span class="mf">2.657</span><span class="p">,</span> <span class="n">divide</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Remove linear continuum fit between wl1 and wl2 from spec.&quot;&quot;&quot;</span>
    <span class="n">slope</span><span class="p">,</span> <span class="n">intercept</span> <span class="o">=</span> <span class="n">lin_contin</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">wl1</span><span class="p">,</span> <span class="n">wl2</span><span class="p">)</span>
    <span class="n">contin</span> <span class="o">=</span> <span class="n">slope</span> <span class="o">*</span> <span class="n">spec</span><span class="o">.</span><span class="n">wavelength</span> <span class="o">+</span> <span class="n">intercept</span>
    <span class="k">if</span> <span class="n">divide</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">spec</span> <span class="o">/</span> <span class="n">contin</span>
    <span class="k">return</span> <span class="n">spec</span> <span class="o">-</span> <span class="n">contin</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="m3_correction.emission_xr_helper" class="doc doc-heading">
<code class="highlight language-python"><span class="n">emission_xr_helper</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Helper function for emission_xr.</p>

          <details class="quote">
            <summary>Source code in <code>roughness/m3_correction.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">emission_xr_helper</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Helper function for emission_xr.&quot;&quot;&quot;</span>
    <span class="c1"># ind is (wls, x, y), drop wls dim and slice other args by (x, y)</span>
    <span class="c1"># ind = tupl[i for i in ind if not (i.start == 0 and i.stop == len(args[4]))]</span>
    <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span> <span class="k">else</span> <span class="n">a</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">args</span><span class="p">)]</span>
    <span class="c1"># kwargs = [k[ind] if isinstance(k, xr.DataArray) else k for k in kwargs]</span>
    <span class="k">return</span> <span class="n">get_emission_xr</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="m3_correction.ext2window" class="doc doc-heading">
<code class="highlight language-python"><span class="n">ext2window</span><span class="p">(</span><span class="n">ext</span><span class="p">,</span> <span class="n">transform</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Return rasterio window of data bounded by ext in dataset with transform.</p>

          <details class="quote">
            <summary>Source code in <code>roughness/m3_correction.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">901</span>
<span class="normal">902</span>
<span class="normal">903</span>
<span class="normal">904</span>
<span class="normal">905</span>
<span class="normal">906</span>
<span class="normal">907</span>
<span class="normal">908</span>
<span class="normal">909</span>
<span class="normal">910</span>
<span class="normal">911</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">ext2window</span><span class="p">(</span><span class="n">ext</span><span class="p">,</span> <span class="n">transform</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return rasterio window of data bounded by ext in dataset with transform.&quot;&quot;&quot;</span>
    <span class="c1"># Location of upper left corner of data (pixel offset)</span>
    <span class="n">row_off</span><span class="p">,</span> <span class="n">col_off</span> <span class="o">=</span> <span class="n">rio</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">rowcol</span><span class="p">(</span><span class="n">transform</span><span class="p">,</span> <span class="n">ext</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ext</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
    <span class="c1"># Size of window (in pixels)</span>
    <span class="n">xres</span> <span class="o">=</span> <span class="n">transform</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">yres</span> <span class="o">=</span> <span class="o">-</span><span class="n">transform</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">ext</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ext</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">xres</span><span class="p">))</span>
    <span class="n">height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">ext</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">ext</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="n">yres</span><span class="p">))</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">rio</span><span class="o">.</span><span class="n">windows</span><span class="o">.</span><span class="n">Window</span><span class="p">(</span><span class="n">col_off</span><span class="p">,</span> <span class="n">row_off</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">w</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="m3_correction.furnsh_kernels" class="doc doc-heading">
<code class="highlight language-python"><span class="n">furnsh_kernels</span><span class="p">(</span><span class="n">kernels_path</span><span class="o">=</span><span class="n">KERNELPATH</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Return spiceypy kernels for meta_path.</p>

          <details class="quote">
            <summary>Source code in <code>roughness/m3_correction.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1153</span>
<span class="normal">1154</span>
<span class="normal">1155</span>
<span class="normal">1156</span>
<span class="normal">1157</span>
<span class="normal">1158</span>
<span class="normal">1159</span>
<span class="normal">1160</span>
<span class="normal">1161</span>
<span class="normal">1162</span>
<span class="normal">1163</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">furnsh_kernels</span><span class="p">(</span><span class="n">kernels_path</span><span class="o">=</span><span class="n">KERNELPATH</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return spiceypy kernels for meta_path.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">kernels</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">kernels_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">kernels</span><span class="o">.</span><span class="n">suffix</span> <span class="o">!=</span> <span class="s2">&quot;.tm&quot;</span><span class="p">:</span>
        <span class="c1"># Get all kernels, exlude meta kernels (&#39;.tm&#39;)</span>
        <span class="n">kernels</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">k</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">kernels</span><span class="o">.</span><span class="n">rglob</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">suffix</span> <span class="o">!=</span> <span class="s2">&quot;.tm&quot;</span>
        <span class="p">]</span>
    <span class="n">spiceypy</span><span class="o">.</span><span class="n">furnsh</span><span class="p">(</span><span class="n">kernels</span><span class="p">)</span>  <span class="c1"># Else assume path is a .tm</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="m3_correction.get_albedo_feng" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_albedo_feng</span><span class="p">(</span><span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Return albedo interpolated from Feng et al. (2020) at lons, lats.</p>

          <details class="quote">
            <summary>Source code in <code>roughness/m3_correction.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">991</span>
<span class="normal">992</span>
<span class="normal">993</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_albedo_feng</span><span class="p">(</span><span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return albedo interpolated from Feng et al. (2020) at lons, lats.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">read_albedo_map_feng</span><span class="p">()</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">lon</span><span class="o">=</span><span class="n">lon180</span><span class="p">(</span><span class="n">lons</span><span class="p">),</span> <span class="n">lat</span><span class="o">=</span><span class="n">lats</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="m3_correction.get_avg_spec" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_avg_spec</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">wlmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">wlmax</span><span class="o">=</span><span class="mf">100000.0</span><span class="p">,</span> <span class="n">wls</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Return the wavelengths and mean spectrum within the specified img array.
Optionally specify min and max wavelengths to crop spectrum.</p>

          <details class="quote">
            <summary>Source code in <code>roughness/m3_correction.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1336</span>
<span class="normal">1337</span>
<span class="normal">1338</span>
<span class="normal">1339</span>
<span class="normal">1340</span>
<span class="normal">1341</span>
<span class="normal">1342</span>
<span class="normal">1343</span>
<span class="normal">1344</span>
<span class="normal">1345</span>
<span class="normal">1346</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_avg_spec</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">wlmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">wlmax</span><span class="o">=</span><span class="mf">1e5</span><span class="p">,</span> <span class="n">wls</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the wavelengths and mean spectrum within the specified img array.</span>
<span class="sd">    Optionally specify min and max wavelengths to crop spectrum.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">):</span>  <span class="c1"># Average along wavelength dimension</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="s2">&quot;lon&quot;</span><span class="p">,</span> <span class="s2">&quot;lat&quot;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>  <span class="c1"># Average along z (spectral) axis</span>
    <span class="k">return</span> <span class="n">get_spec</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">wlmin</span><span class="p">,</span> <span class="n">wlmax</span><span class="p">,</span> <span class="n">wls</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="m3_correction.get_avg_sun_inc_az" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_avg_sun_inc_az</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">dem</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Return average solar incidence and azimuth from obs file.</p>

          <details class="quote">
            <summary>Source code in <code>roughness/m3_correction.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_avg_sun_inc_az</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">dem</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return average solar incidence and azimuth from obs file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sun_thetas</span><span class="p">,</span> <span class="n">sun_azs</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">get_m3_geom</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">dem</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">sun_thetas</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">sun_azs</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="m3_correction.get_dem_geotiff" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_dem_geotiff</span><span class="p">(</span><span class="n">fslo</span><span class="p">,</span> <span class="n">fazim</span><span class="p">,</span> <span class="n">felev</span><span class="p">,</span> <span class="n">ext</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">resampling</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Return DEM geotiff from fslo, fazim, felev geotiff files.</p>

          <details class="quote">
            <summary>Source code in <code>roughness/m3_correction.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1301</span>
<span class="normal">1302</span>
<span class="normal">1303</span>
<span class="normal">1304</span>
<span class="normal">1305</span>
<span class="normal">1306</span>
<span class="normal">1307</span>
<span class="normal">1308</span>
<span class="normal">1309</span>
<span class="normal">1310</span>
<span class="normal">1311</span>
<span class="normal">1312</span>
<span class="normal">1313</span>
<span class="normal">1314</span>
<span class="normal">1315</span>
<span class="normal">1316</span>
<span class="normal">1317</span>
<span class="normal">1318</span>
<span class="normal">1319</span>
<span class="normal">1320</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_dem_geotiff</span><span class="p">(</span>
    <span class="n">fslo</span><span class="p">,</span> <span class="n">fazim</span><span class="p">,</span> <span class="n">felev</span><span class="p">,</span> <span class="n">ext</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">resampling</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return DEM geotiff from fslo, fazim, felev geotiff files.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">bot</span><span class="p">,</span> <span class="n">top</span> <span class="o">=</span> <span class="n">ext</span>
    <span class="n">rs</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">rio</span><span class="o">.</span><span class="n">enums</span><span class="o">.</span><span class="n">Resampling</span><span class="p">,</span> <span class="n">resampling</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">rio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fslo</span><span class="p">)</span> <span class="k">as</span> <span class="n">s</span><span class="p">,</span> <span class="n">rio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fazim</span><span class="p">)</span> <span class="k">as</span> <span class="n">a</span><span class="p">,</span> <span class="n">rio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">felev</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">rio</span><span class="o">.</span><span class="n">windows</span><span class="o">.</span><span class="n">from_bounds</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">bot</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">top</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">transform</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">width</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">width</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">height</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">height</span><span class="p">)</span>
        <span class="n">outshape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span>
        <span class="n">slo</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">w</span><span class="p">,</span> <span class="n">out_shape</span><span class="o">=</span><span class="n">outshape</span><span class="p">,</span> <span class="n">resampling</span><span class="o">=</span><span class="n">rs</span><span class="p">)</span>
        <span class="n">azim</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">w</span><span class="p">,</span> <span class="n">out_shape</span><span class="o">=</span><span class="n">outshape</span><span class="p">,</span> <span class="n">resampling</span><span class="o">=</span><span class="n">rs</span><span class="p">)</span>
        <span class="n">elev</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">w</span><span class="p">,</span> <span class="n">out_shape</span><span class="o">=</span><span class="n">outshape</span><span class="p">,</span> <span class="n">resampling</span><span class="o">=</span><span class="n">rs</span><span class="p">)</span>
    <span class="n">dem</span> <span class="o">=</span> <span class="n">rio2xy</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">slo</span><span class="p">,</span> <span class="n">azim</span><span class="p">,</span> <span class="n">elev</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">dem</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="m3_correction.get_dem_xr" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_dem_xr</span><span class="p">(</span><span class="n">fslope</span><span class="p">,</span> <span class="n">fazimuth</span><span class="p">,</span> <span class="n">felevation</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Return DEM as xarray from fslope, fazimuth, felevation</p>

          <details class="quote">
            <summary>Source code in <code>roughness/m3_correction.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1288</span>
<span class="normal">1289</span>
<span class="normal">1290</span>
<span class="normal">1291</span>
<span class="normal">1292</span>
<span class="normal">1293</span>
<span class="normal">1294</span>
<span class="normal">1295</span>
<span class="normal">1296</span>
<span class="normal">1297</span>
<span class="normal">1298</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_dem_xr</span><span class="p">(</span><span class="n">fslope</span><span class="p">,</span> <span class="n">fazimuth</span><span class="p">,</span> <span class="n">felevation</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return DEM as xarray from fslope, fazimuth, felevation&quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataarray</span><span class="p">(</span><span class="n">fslope</span><span class="p">)</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">band</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;band&quot;</span><span class="p">)</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataarray</span><span class="p">(</span><span class="n">fazimuth</span><span class="p">)</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">band</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;band&quot;</span><span class="p">)</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataarray</span><span class="p">(</span><span class="n">felevation</span><span class="p">)</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">band</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;band&quot;</span><span class="p">)</span>
    <span class="n">s</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Slope (rad)&quot;</span>
    <span class="n">a</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Aspect (rad)&quot;</span>
    <span class="n">e</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Elevation&quot;</span>
    <span class="n">dem</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">({</span><span class="s2">&quot;slope&quot;</span><span class="p">:</span> <span class="n">s</span><span class="p">,</span> <span class="s2">&quot;aspect&quot;</span><span class="p">:</span> <span class="n">a</span><span class="p">,</span> <span class="s2">&quot;elevation&quot;</span><span class="p">:</span> <span class="n">e</span><span class="p">})</span>
    <span class="n">dem</span> <span class="o">=</span> <span class="n">dem</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="s2">&quot;lon&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="s2">&quot;lat&quot;</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">dem</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="m3_correction.get_emission_xr" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_emission_xr</span><span class="p">(</span><span class="n">inc</span><span class="p">,</span> <span class="n">iaz</span><span class="p">,</span> <span class="n">em</span><span class="p">,</span> <span class="n">eaz</span><span class="p">,</span> <span class="n">alb</span><span class="p">,</span> <span class="n">wls</span><span class="p">,</span> <span class="n">tloc</span><span class="p">,</span> <span class="n">ls</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Return emission [W/(m^2 um)].</p>

          <details class="quote">
            <summary>Source code in <code>roughness/m3_correction.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_emission_xr</span><span class="p">(</span><span class="n">inc</span><span class="p">,</span> <span class="n">iaz</span><span class="p">,</span> <span class="n">em</span><span class="p">,</span> <span class="n">eaz</span><span class="p">,</span> <span class="n">alb</span><span class="p">,</span> <span class="n">wls</span><span class="p">,</span> <span class="n">tloc</span><span class="p">,</span> <span class="n">ls</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return emission [W/(m^2 um)].&quot;&quot;&quot;</span>
    <span class="n">emission</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">inc</span> <span class="o">*</span> <span class="n">wls</span><span class="p">)</span>
    <span class="n">dorig</span> <span class="o">=</span> <span class="n">emission</span><span class="o">.</span><span class="n">dims</span>
    <span class="n">dim0</span><span class="p">,</span> <span class="n">dim1</span> <span class="o">=</span> <span class="p">[</span><span class="n">dim</span> <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">inc</span><span class="o">.</span><span class="n">dims</span> <span class="k">if</span> <span class="n">dim</span> <span class="o">!=</span> <span class="s2">&quot;band&quot;</span><span class="p">]</span>
    <span class="n">emission</span> <span class="o">=</span> <span class="n">emission</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">dim0</span><span class="p">,</span> <span class="n">dim1</span><span class="p">,</span> <span class="s2">&quot;wavelength&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">emission</span><span class="p">[</span><span class="n">dim0</span><span class="p">])):</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">emission</span><span class="p">[</span><span class="n">dim1</span><span class="p">])):</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="p">{</span><span class="n">dim0</span><span class="p">:</span> <span class="n">j</span><span class="p">,</span> <span class="n">dim1</span><span class="p">:</span> <span class="n">k</span><span class="p">}</span>
            <span class="n">geom</span> <span class="o">=</span> <span class="p">[</span><span class="n">da</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span><span class="o">.</span><span class="n">values</span> <span class="k">for</span> <span class="n">da</span> <span class="ow">in</span> <span class="p">[</span><span class="n">inc</span><span class="p">,</span> <span class="n">iaz</span><span class="p">,</span> <span class="n">em</span><span class="p">,</span> <span class="n">eaz</span><span class="p">]]</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">geom</span><span class="p">]):</span>
                <span class="k">continue</span>
            <span class="n">albedo</span> <span class="o">=</span> <span class="n">alb</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
            <span class="k">if</span> <span class="n">lat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">lat</span> <span class="o">=</span> <span class="n">inc</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">values</span>
            <span class="n">tparams</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;tloc&quot;</span><span class="p">:</span> <span class="n">tloc</span><span class="p">,</span> <span class="s2">&quot;albedo&quot;</span><span class="p">:</span> <span class="n">albedo</span><span class="p">,</span> <span class="s2">&quot;lat&quot;</span><span class="p">:</span> <span class="n">lat</span><span class="p">,</span> <span class="s2">&quot;ls&quot;</span><span class="p">:</span> <span class="n">ls</span><span class="p">}</span>

            <span class="n">emission</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">rough_emission_lookup</span><span class="p">(</span>
                <span class="n">geom</span><span class="p">,</span> <span class="n">wls</span><span class="p">,</span> <span class="n">tparams</span><span class="o">=</span><span class="n">tparams</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
            <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
    <span class="c1"># Transpose back to original axis order</span>
    <span class="n">emission</span> <span class="o">=</span> <span class="n">emission</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="o">*</span><span class="n">dorig</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">emission</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="m3_correction.get_ls_spice" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_ls_spice</span><span class="p">(</span><span class="n">basename</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Return solar longitude (L_s) from basename.</p>

          <details class="quote">
            <summary>Source code in <code>roughness/m3_correction.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1233</span>
<span class="normal">1234</span>
<span class="normal">1235</span>
<span class="normal">1236</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_ls_spice</span><span class="p">(</span><span class="n">basename</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return solar longitude (L_s) from basename.&quot;&quot;&quot;</span>
    <span class="n">utc</span> <span class="o">=</span> <span class="n">m3basename2utc</span><span class="p">(</span><span class="n">basename</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">utc2lsmoon</span><span class="p">(</span><span class="n">utc</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="m3_correction.get_m3_date" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_m3_date</span><span class="p">(</span><span class="n">basename</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Return date object representing date of M3 observation</p>

          <details class="quote">
            <summary>Source code in <code>roughness/m3_correction.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_m3_date</span><span class="p">(</span><span class="n">basename</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return date object representing date of M3 observation&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">basename</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span> <span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">%H%M%S&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="m3_correction.get_m3_directory" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_m3_directory</span><span class="p">(</span><span class="n">basename</span><span class="p">,</span> <span class="n">dirpath</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;L2&#39;</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Return PDS-like path to M3 observation, given basename and dirpath to m3
root directory.</p>

          <details class="quote">
            <summary>Source code in <code>roughness/m3_correction.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_m3_directory</span><span class="p">(</span><span class="n">basename</span><span class="p">,</span> <span class="n">dirpath</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;L2&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return PDS-like path to M3 observation, given basename and dirpath to m3</span>
<span class="sd">    root directory.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Build M3 data path as list, join at the end</span>
    <span class="n">m3dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">dirpath</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">level</span> <span class="o">==</span> <span class="s2">&quot;L1B&quot;</span><span class="p">:</span>
        <span class="n">m3dir</span> <span class="o">=</span> <span class="n">m3dir</span> <span class="o">/</span> <span class="s2">&quot;CH1M3_0003&quot;</span>
    <span class="k">elif</span> <span class="n">level</span> <span class="o">==</span> <span class="s2">&quot;L2&quot;</span><span class="p">:</span>
        <span class="n">m3dir</span> <span class="o">=</span> <span class="n">m3dir</span> <span class="o">/</span> <span class="s2">&quot;CH1M3_0004&quot;</span>
    <span class="n">m3dir</span> <span class="o">=</span> <span class="n">m3dir</span> <span class="o">/</span> <span class="s2">&quot;DATA&quot;</span>

    <span class="c1"># Get optical period</span>
    <span class="n">opt</span> <span class="o">=</span> <span class="n">get_m3_op</span><span class="p">(</span><span class="n">basename</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">opt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span><span class="p">:</span>
        <span class="n">m3dir</span> <span class="o">=</span> <span class="n">m3dir</span> <span class="o">/</span> <span class="s2">&quot;20081118_20090214&quot;</span>
    <span class="k">elif</span> <span class="n">opt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;2&quot;</span><span class="p">:</span>
        <span class="n">m3dir</span> <span class="o">=</span> <span class="n">m3dir</span> <span class="o">/</span> <span class="s2">&quot;20090415_20090816&quot;</span>

    <span class="n">m3dir</span> <span class="o">=</span> <span class="n">m3dir</span> <span class="o">/</span> <span class="n">basename</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">9</span><span class="p">]</span> <span class="o">/</span> <span class="n">level</span>
    <span class="k">return</span> <span class="n">m3dir</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="m3_correction.get_m3_geom" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_m3_geom</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">dem</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Return geometry array from M3 observation file and optional dem.</p>

          <details class="quote">
            <summary>Source code in <code>roughness/m3_correction.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_m3_geom</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">dem</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return geometry array from M3 observation file and optional dem.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">dem</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dem_theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">obs</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">7</span><span class="p">])</span>
        <span class="n">dem_az</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">obs</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">8</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dem_theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">dem</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">dem_az</span> <span class="o">=</span> <span class="n">dem</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">sun_az</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">obs</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">sun_theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">obs</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">sc_az</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">obs</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">])</span>
    <span class="n">sc_theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">obs</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">3</span><span class="p">])</span>

    <span class="c1"># Compute angles in degrees</span>
    <span class="n">i</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">rh</span><span class="o">.</span><span class="n">get_ieg</span><span class="p">(</span>
        <span class="n">dem_theta</span><span class="p">,</span> <span class="n">dem_az</span><span class="p">,</span> <span class="n">sun_theta</span><span class="p">,</span> <span class="n">sun_az</span><span class="p">,</span> <span class="n">sc_theta</span><span class="p">,</span> <span class="n">sc_az</span>
    <span class="p">)</span>
    <span class="n">sun_az</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">sun_az</span><span class="p">)</span>
    <span class="n">sc_az</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">sc_az</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">i</span><span class="p">,</span> <span class="n">sun_az</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">sc_az</span><span class="p">,</span> <span class="n">g</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="m3_correction.get_m3_geom_xr" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_m3_geom_xr</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">dem</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Return geometry from M3 observation file and optional dem as xarray.</p>

          <details class="quote">
            <summary>Source code in <code>roughness/m3_correction.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_m3_geom_xr</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">dem</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return geometry from M3 observation file and optional dem as xarray.&quot;&quot;&quot;</span>
    <span class="n">sun_az</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">band</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># To-sun azimuth [deg]</span>
    <span class="n">sun_z</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">band</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># To-sun zenith [deg]</span>
    <span class="n">sc_az</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">band</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>  <span class="c1"># To-spacecraft azimuth [deg]</span>
    <span class="n">sc_z</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">band</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>  <span class="c1"># To-spacecraft zenith [deg]</span>
    <span class="k">if</span> <span class="n">dem</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Pull cos(i) relative to dem and phase from obs</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">band</span><span class="o">=</span><span class="mi">10</span><span class="p">)))</span>  <span class="c1"># Incidence [deg]</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">band</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>  <span class="c1"># Phase [deg]</span>

        <span class="c1"># Compute e relative to dem</span>
        <span class="n">dem_sl</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">band</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>  <span class="c1"># Facet slope [deg]</span>
        <span class="n">dem_az</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">band</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>  <span class="c1"># Facet azimuth [deg]</span>
        <span class="n">dem_cart</span> <span class="o">=</span> <span class="n">rh</span><span class="o">.</span><span class="n">sph2cart_xr</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">dem_sl</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">dem_az</span><span class="p">))</span>
        <span class="n">sc_cart</span> <span class="o">=</span> <span class="n">rh</span><span class="o">.</span><span class="n">sph2cart_xr</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">sc_z</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">sc_az</span><span class="p">))</span>
        <span class="n">e</span> <span class="o">=</span> <span class="n">rh</span><span class="o">.</span><span class="n">get_angle_between_xr</span><span class="p">(</span><span class="n">dem_cart</span><span class="p">,</span> <span class="n">sc_cart</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Compute i,e,g relative to dem</span>
        <span class="n">dem_sl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">dem</span><span class="o">.</span><span class="n">slope</span><span class="p">)</span>  <span class="c1"># [radians]</span>
        <span class="n">dem_az</span> <span class="o">=</span> <span class="n">dem</span><span class="o">.</span><span class="n">aspect</span>  <span class="c1"># [radians]</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="p">[</span><span class="n">sun_z</span><span class="p">,</span> <span class="n">sun_az</span><span class="p">,</span> <span class="n">sc_z</span><span class="p">,</span> <span class="n">sc_az</span><span class="p">]]</span>
        <span class="n">i</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">rh</span><span class="o">.</span><span class="n">get_ieg_xr</span><span class="p">(</span><span class="n">dem_sl</span><span class="p">,</span> <span class="n">dem_az</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">i</span><span class="p">,</span> <span class="n">sun_az</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">sc_az</span><span class="p">,</span> <span class="n">g</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="m3_correction.get_m3_headers" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_m3_headers</span><span class="p">(</span><span class="n">basename</span><span class="p">,</span> <span class="n">dirpath</span><span class="o">=</span><span class="n">M3PATH</span><span class="p">,</span> <span class="n">flatdir</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">imgs</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;rad&#39;</span><span class="p">,</span> <span class="s1">&#39;ref&#39;</span><span class="p">,</span> <span class="s1">&#39;obs&#39;</span><span class="p">,</span> <span class="s1">&#39;sup&#39;</span><span class="p">,</span> <span class="s1">&#39;loc&#39;</span><span class="p">),</span> <span class="n">usgs</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">usgspath</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="s1">&#39;.HDR&#39;</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Return dict of paths to M3 header files for an observation.</p>
<h4 id="m3_correction.get_m3_headers--see-also">See Also</h4>
<p>https://astrogeology.usgs.gov/maps/
        moon-mineralogy-mapper-geometric-data-restoration</p>
<h4 id="m3_correction.get_m3_headers--examples">Examples</h4>
<blockquote>
<blockquote>
<blockquote>
<p>get_m3_headers("M3G20090609T183254", dirpath="/path/to/m3")
{'rad': '/path/to/m3/CH1M3_0003/DATA/20090415_20090816/200906/L1B/
         M3G20090609T183254_V03_RDN.HDR',
'ref': '/path/to/m3/CH1M3_0004/DATA/20090415_20090816/200906/L2/
        M3G20090609T183254_V01_RFL.HDR',
'obs': '/path/to/m3/CH1M3_0003/DATA/20090415_20090816/200906/L1B/
        M3G20090609T183254_V03_OBS.HDR',
'sup': '/path/to/m3/CH1M3_0004/DATA/20090415_20090816/200906/L2/
        M3G20090609T183254_V01_SUP.HDR',
'loc': '/path/to/m3/CH1M3_0003/DATA/20090415_20090816/200906/L1B/
        M3G20090609T183254_V03_LOC.HDR'}
get_m3_headers("M3G20090609T183254", dirpath="/path/to/imgs",
                   flatdir=True)
{'rad': '/path/to/imgs/M3G20090609T183254_V03_RDN.HDR',
'ref': '/path/to/imgs/M3G20090609T183254_V01_RFL.HDR',
'obs': '/path/to/imgs/M3G20090609T183254_V03_OBS.HDR',
'sup': '/path/to/imgs/M3G20090609T183254_V01_SUP.HDR',
'loc': '/path/to/imgs/M3G20090609T183254_V03_LOC.HDR'}
get_m3_headers("M3G20090609T183254", dirpath="m3path", usgs=1,
                    usgspath="usgspath")
{'rad': 'm3path/CH1M3_0003/DATA/20090415_20090816/200906/L1B/
         M3G20090609T183254_V03_RDN.HDR',
'ref': 'm3path/CH1M3_0004/DATA/20090415_20090816/200906/L2/
        M3G20090609T183254_V01_RFL.HDR',
'obs': 'usgspath/boardman2014/M3G20090609T183254_V03_OBS.HDR',
'sup': 'm3path/CH1M3_0004/DATA/20090415_20090816/200906/L2/
        M3G20090609T183254_V01_SUP.HDR',
'loc': 'usgspath/boardman2014/M3G20090609T183254_V03_LOC.HDR'}</p>
</blockquote>
</blockquote>
</blockquote>

          <details class="quote">
            <summary>Source code in <code>roughness/m3_correction.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_m3_headers</span><span class="p">(</span>
    <span class="n">basename</span><span class="p">,</span>
    <span class="n">dirpath</span><span class="o">=</span><span class="n">M3PATH</span><span class="p">,</span>
    <span class="n">flatdir</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">imgs</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;rad&quot;</span><span class="p">,</span> <span class="s2">&quot;ref&quot;</span><span class="p">,</span> <span class="s2">&quot;obs&quot;</span><span class="p">,</span> <span class="s2">&quot;sup&quot;</span><span class="p">,</span> <span class="s2">&quot;loc&quot;</span><span class="p">),</span>
    <span class="n">usgs</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">usgspath</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">ext</span><span class="o">=</span><span class="s2">&quot;.HDR&quot;</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return dict of paths to M3 header files for an observation.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    https://astrogeology.usgs.gov/maps/</span>
<span class="sd">            moon-mineralogy-mapper-geometric-data-restoration</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; get_m3_headers(&quot;M3G20090609T183254&quot;, dirpath=&quot;/path/to/m3&quot;)</span>
<span class="sd">    {&#39;rad&#39;: &#39;/path/to/m3/CH1M3_0003/DATA/20090415_20090816/200906/L1B/</span>
<span class="sd">             M3G20090609T183254_V03_RDN.HDR&#39;,</span>
<span class="sd">    &#39;ref&#39;: &#39;/path/to/m3/CH1M3_0004/DATA/20090415_20090816/200906/L2/</span>
<span class="sd">            M3G20090609T183254_V01_RFL.HDR&#39;,</span>
<span class="sd">    &#39;obs&#39;: &#39;/path/to/m3/CH1M3_0003/DATA/20090415_20090816/200906/L1B/</span>
<span class="sd">            M3G20090609T183254_V03_OBS.HDR&#39;,</span>
<span class="sd">    &#39;sup&#39;: &#39;/path/to/m3/CH1M3_0004/DATA/20090415_20090816/200906/L2/</span>
<span class="sd">            M3G20090609T183254_V01_SUP.HDR&#39;,</span>
<span class="sd">    &#39;loc&#39;: &#39;/path/to/m3/CH1M3_0003/DATA/20090415_20090816/200906/L1B/</span>
<span class="sd">            M3G20090609T183254_V03_LOC.HDR&#39;}</span>
<span class="sd">    &gt;&gt;&gt; get_m3_headers(&quot;M3G20090609T183254&quot;, dirpath=&quot;/path/to/imgs&quot;,</span>
<span class="sd">                       flatdir=True)</span>
<span class="sd">    {&#39;rad&#39;: &#39;/path/to/imgs/M3G20090609T183254_V03_RDN.HDR&#39;,</span>
<span class="sd">    &#39;ref&#39;: &#39;/path/to/imgs/M3G20090609T183254_V01_RFL.HDR&#39;,</span>
<span class="sd">    &#39;obs&#39;: &#39;/path/to/imgs/M3G20090609T183254_V03_OBS.HDR&#39;,</span>
<span class="sd">    &#39;sup&#39;: &#39;/path/to/imgs/M3G20090609T183254_V01_SUP.HDR&#39;,</span>
<span class="sd">    &#39;loc&#39;: &#39;/path/to/imgs/M3G20090609T183254_V03_LOC.HDR&#39;}</span>
<span class="sd">    &gt;&gt;&gt; get_m3_headers(&quot;M3G20090609T183254&quot;, dirpath=&quot;m3path&quot;, usgs=1,</span>
<span class="sd">                        usgspath=&quot;usgspath&quot;)</span>
<span class="sd">    {&#39;rad&#39;: &#39;m3path/CH1M3_0003/DATA/20090415_20090816/200906/L1B/</span>
<span class="sd">             M3G20090609T183254_V03_RDN.HDR&#39;,</span>
<span class="sd">    &#39;ref&#39;: &#39;m3path/CH1M3_0004/DATA/20090415_20090816/200906/L2/</span>
<span class="sd">            M3G20090609T183254_V01_RFL.HDR&#39;,</span>
<span class="sd">    &#39;obs&#39;: &#39;usgspath/boardman2014/M3G20090609T183254_V03_OBS.HDR&#39;,</span>
<span class="sd">    &#39;sup&#39;: &#39;m3path/CH1M3_0004/DATA/20090415_20090816/200906/L2/</span>
<span class="sd">            M3G20090609T183254_V01_SUP.HDR&#39;,</span>
<span class="sd">    &#39;loc&#39;: &#39;usgspath/boardman2014/M3G20090609T183254_V03_LOC.HDR&#39;}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">single_img</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">imgs</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">single_img</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">imgs</span> <span class="o">=</span> <span class="p">[</span><span class="n">imgs</span><span class="p">]</span>

    <span class="n">img2name</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;rad&quot;</span><span class="p">:</span> <span class="s2">&quot;RDN&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ref&quot;</span><span class="p">:</span> <span class="s2">&quot;RFL&quot;</span><span class="p">,</span>
        <span class="s2">&quot;obs&quot;</span><span class="p">:</span> <span class="s2">&quot;OBS&quot;</span><span class="p">,</span>
        <span class="s2">&quot;sup&quot;</span><span class="p">:</span> <span class="s2">&quot;SUP&quot;</span><span class="p">,</span>
        <span class="s2">&quot;loc&quot;</span><span class="p">:</span> <span class="s2">&quot;LOC&quot;</span><span class="p">,</span>
        <span class="s2">&quot;lbl&quot;</span><span class="p">:</span> <span class="s2">&quot;L1B&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">flatdir</span><span class="p">:</span>
        <span class="c1"># All images in toplevel directory at dirpath</span>
        <span class="n">l1b</span> <span class="o">=</span> <span class="n">dirpath</span>
        <span class="n">l2</span> <span class="o">=</span> <span class="n">dirpath</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Full m3 volume located at dirpath</span>
        <span class="n">l1b</span> <span class="o">=</span> <span class="n">get_m3_directory</span><span class="p">(</span><span class="n">basename</span><span class="p">,</span> <span class="n">dirpath</span><span class="p">,</span> <span class="s2">&quot;L1B&quot;</span><span class="p">)</span>
        <span class="n">l2</span> <span class="o">=</span> <span class="n">get_m3_directory</span><span class="p">(</span><span class="n">basename</span><span class="p">,</span> <span class="n">dirpath</span><span class="p">,</span> <span class="s2">&quot;L2&quot;</span><span class="p">)</span>

    <span class="c1"># Get full path for each img</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">imgs</span><span class="p">:</span>
        <span class="n">_ext</span> <span class="o">=</span> <span class="n">ext</span>
        <span class="k">if</span> <span class="n">img</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;rad&quot;</span><span class="p">,</span> <span class="s2">&quot;loc&quot;</span><span class="p">,</span> <span class="s2">&quot;obs&quot;</span><span class="p">,</span> <span class="s2">&quot;lbl&quot;</span><span class="p">):</span>
            <span class="n">version</span> <span class="o">=</span> <span class="s2">&quot;V03&quot;</span>
            <span class="n">level</span> <span class="o">=</span> <span class="n">l1b</span>
            <span class="k">if</span> <span class="n">img</span> <span class="o">==</span> <span class="s2">&quot;lbl&quot;</span><span class="p">:</span>
                <span class="n">_ext</span> <span class="o">=</span> <span class="s2">&quot;.LBL&quot;</span>
        <span class="k">elif</span> <span class="n">img</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;ref&quot;</span><span class="p">,</span> <span class="s2">&quot;sup&quot;</span><span class="p">):</span>
            <span class="n">version</span> <span class="o">=</span> <span class="s2">&quot;V01&quot;</span>
            <span class="n">level</span> <span class="o">=</span> <span class="n">l2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown image type: </span><span class="si">{</span><span class="n">img</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">basename</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">img2name</span><span class="p">[</span><span class="n">img</span><span class="p">]</span> <span class="o">+</span> <span class="n">_ext</span><span class="p">))</span>
        <span class="n">headers</span><span class="p">[</span><span class="n">img</span><span class="p">]</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">level</span><span class="p">)</span> <span class="o">/</span> <span class="n">fname</span>

    <span class="c1"># USGS corrected loc and obs</span>
    <span class="k">if</span> <span class="n">usgs</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">usgspath</span><span class="p">:</span>
            <span class="n">usgspath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">dirpath</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;USGS&quot;</span>
        <span class="k">if</span> <span class="n">usgs</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Step 1 usgs correction (2014)</span>
            <span class="n">usgsdir</span> <span class="o">=</span> <span class="s2">&quot;boardman2014&quot;</span>
            <span class="n">loc</span> <span class="o">=</span> <span class="n">basename</span> <span class="o">+</span> <span class="s2">&quot;_V03_LOC.HDR&quot;</span>
            <span class="n">obs</span> <span class="o">=</span> <span class="n">basename</span> <span class="o">+</span> <span class="s2">&quot;_V03_OBS.HDR&quot;</span>
        <span class="k">elif</span> <span class="n">usgs</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c1"># Step 2 usgs correction (2017)</span>
            <span class="n">usgsdir</span> <span class="o">=</span> <span class="s2">&quot;boardman2017&quot;</span>
            <span class="n">loc</span> <span class="o">=</span> <span class="n">basename</span> <span class="o">+</span> <span class="s2">&quot;_V03_L1B_LOC_USGS.hdr&quot;</span>
            <span class="n">obs</span> <span class="o">=</span> <span class="n">basename</span> <span class="o">+</span> <span class="s2">&quot;_V03_L1B_OBS.HDR&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid usgs step (must be 1 or 2)&quot;</span><span class="p">)</span>
        <span class="n">headers</span><span class="p">[</span><span class="s2">&quot;loc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">usgspath</span><span class="p">)</span> <span class="o">/</span> <span class="n">usgsdir</span> <span class="o">/</span> <span class="n">loc</span>
        <span class="n">headers</span><span class="p">[</span><span class="s2">&quot;obs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">usgspath</span><span class="p">)</span> <span class="o">/</span> <span class="n">usgsdir</span> <span class="o">/</span> <span class="n">obs</span>
    <span class="k">if</span> <span class="n">single_img</span><span class="p">:</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="n">headers</span><span class="p">[</span><span class="n">imgs</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="k">return</span> <span class="n">headers</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="m3_correction.get_m3_op" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_m3_op</span><span class="p">(</span><span class="n">basename</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Return optical period of m3 observation based on date of observation</p>

          <details class="quote">
            <summary>Source code in <code>roughness/m3_correction.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_m3_op</span><span class="p">(</span><span class="n">basename</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return optical period of m3 observation based on date of observation&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">date_in_range</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">):</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">start</span> <span class="o">&lt;=</span> <span class="n">date</span> <span class="o">&lt;</span> <span class="n">end</span>

    <span class="n">date</span> <span class="o">=</span> <span class="n">get_m3_date</span><span class="p">(</span><span class="n">basename</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">date_in_range</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="s2">&quot;20081118&quot;</span><span class="p">,</span> <span class="s2">&quot;20090125&quot;</span><span class="p">):</span>
        <span class="n">opt</span> <span class="o">=</span> <span class="s2">&quot;OP1A&quot;</span>
    <span class="k">elif</span> <span class="n">date_in_range</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="s2">&quot;20090125&quot;</span><span class="p">,</span> <span class="s2">&quot;20090215&quot;</span><span class="p">):</span>
        <span class="n">opt</span> <span class="o">=</span> <span class="s2">&quot;OP1B&quot;</span>
    <span class="k">elif</span> <span class="n">date_in_range</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="s2">&quot;20090415&quot;</span><span class="p">,</span> <span class="s2">&quot;20090428&quot;</span><span class="p">):</span>
        <span class="n">opt</span> <span class="o">=</span> <span class="s2">&quot;OP2A&quot;</span>
    <span class="k">elif</span> <span class="n">date_in_range</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="s2">&quot;20090513&quot;</span><span class="p">,</span> <span class="s2">&quot;20090517&quot;</span><span class="p">):</span>
        <span class="n">opt</span> <span class="o">=</span> <span class="s2">&quot;OP2B&quot;</span>
    <span class="k">elif</span> <span class="n">date_in_range</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="s2">&quot;20090520&quot;</span><span class="p">,</span> <span class="s2">&quot;20090623&quot;</span><span class="p">):</span>
        <span class="n">opt</span> <span class="o">=</span> <span class="s2">&quot;OP2C1&quot;</span>
    <span class="k">elif</span> <span class="n">date_in_range</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="s2">&quot;20090623&quot;</span><span class="p">,</span> <span class="s2">&quot;20090722&quot;</span><span class="p">):</span>
        <span class="n">opt</span> <span class="o">=</span> <span class="s2">&quot;OP2C2&quot;</span>
    <span class="k">elif</span> <span class="n">date_in_range</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="s2">&quot;20090722&quot;</span><span class="p">,</span> <span class="s2">&quot;20090817&quot;</span><span class="p">):</span>
        <span class="n">opt</span> <span class="o">=</span> <span class="s2">&quot;OP2C3&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Optical period for </span><span class="si">{</span><span class="n">basename</span><span class="si">}</span><span class="s2"> not found. Check img name.&quot;</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">opt</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="m3_correction.get_m3_res" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_m3_res</span><span class="p">(</span><span class="n">basename</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Return the M3 spatial resolution in m/pixel which depends on the
operational mode (Global or Target) and the spacecraft altitude (doubled
in OP2C).</p>

          <details class="quote">
            <summary>Source code in <code>roughness/m3_correction.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">938</span>
<span class="normal">939</span>
<span class="normal">940</span>
<span class="normal">941</span>
<span class="normal">942</span>
<span class="normal">943</span>
<span class="normal">944</span>
<span class="normal">945</span>
<span class="normal">946</span>
<span class="normal">947</span>
<span class="normal">948</span>
<span class="normal">949</span>
<span class="normal">950</span>
<span class="normal">951</span>
<span class="normal">952</span>
<span class="normal">953</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_m3_res</span><span class="p">(</span><span class="n">basename</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the M3 spatial resolution in m/pixel which depends on the</span>
<span class="sd">    operational mode (Global or Target) and the spacecraft altitude (doubled</span>
<span class="sd">    in OP2C).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mode</span> <span class="o">=</span> <span class="n">basename</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;G&quot;</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="mi">140</span>  <span class="c1"># m/pixel</span>
    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;T&quot;</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="mi">70</span>  <span class="c1"># m/pixel</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Basename must begin with M3G or M3T.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">get_m3_op</span><span class="p">(</span><span class="n">basename</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;OP2C1&quot;</span><span class="p">,</span> <span class="s2">&quot;OP2C2&quot;</span><span class="p">,</span> <span class="s2">&quot;OP2C3&quot;</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">*=</span> <span class="mi">2</span>
    <span class="k">return</span> <span class="n">res</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="m3_correction.get_m3_tloc" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_m3_tloc</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">dem</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Return average local time of M3 observation.</p>

          <details class="quote">
            <summary>Source code in <code>roughness/m3_correction.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_m3_tloc</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">dem</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return average local time of M3 observation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">rh</span><span class="o">.</span><span class="n">inc_to_tloc</span><span class="p">(</span><span class="o">*</span><span class="n">get_avg_sun_inc_az</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">dem</span><span class="p">),</span> <span class="n">lat</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="m3_correction.get_m3_warm" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_m3_warm</span><span class="p">(</span><span class="n">basename</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Return True if m3 observation was warm (Besse et al., 2013).</p>

          <details class="quote">
            <summary>Source code in <code>roughness/m3_correction.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_m3_warm</span><span class="p">(</span><span class="n">basename</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return True if m3 observation was warm (Besse et al., 2013).&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">get_m3_op</span><span class="p">(</span><span class="n">basename</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;OP1A&quot;</span><span class="p">,</span> <span class="s2">&quot;OP2B&quot;</span><span class="p">,</span> <span class="s2">&quot;OP2C1&quot;</span><span class="p">,</span> <span class="s2">&quot;OP2C2&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="m3_correction.get_m3_wls" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_m3_wls</span><span class="p">(</span><span class="n">img</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Return wavelength array for an M3 image [microns].</p>

          <details class="quote">
            <summary>Source code in <code>roughness/m3_correction.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_m3_wls</span><span class="p">(</span><span class="n">img</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return wavelength array for an M3 image [microns].</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">is_targeted</span><span class="p">(</span><span class="n">img</span><span class="p">):</span>
        <span class="n">wls</span> <span class="o">=</span> <span class="n">TWL</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">wls</span> <span class="o">=</span> <span class="n">GWL</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">wls</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span>  <span class="c1"># [nm] -&gt; [microns]</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="m3_correction.get_m3albedo" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_m3albedo</span><span class="p">(</span><span class="n">rad</span><span class="p">,</span> <span class="n">obs</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">basename</span><span class="p">,</span> <span class="n">wlmin</span><span class="o">=</span><span class="mf">0.55</span><span class="p">,</span> <span class="n">wlmax</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">amax</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Return albedo (Bandfield et al. 2018)</p>

          <details class="quote">
            <summary>Source code in <code>roughness/m3_correction.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_m3albedo</span><span class="p">(</span><span class="n">rad</span><span class="p">,</span> <span class="n">obs</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">basename</span><span class="p">,</span> <span class="n">wlmin</span><span class="o">=</span><span class="mf">0.55</span><span class="p">,</span> <span class="n">wlmax</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">amax</span><span class="o">=</span><span class="mf">0.4</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return albedo (Bandfield et al. 2018)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Add factor to change M3 derived albedo to thermal albedo - JB</span>
    <span class="n">factor</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

    <span class="c1"># Get solar irradiance</span>
    <span class="n">L_sun</span> <span class="o">=</span> <span class="n">get_solar_irradiance_xr</span><span class="p">(</span><span class="n">basename</span><span class="p">,</span> <span class="n">obs</span><span class="p">)</span>
    <span class="n">photom</span> <span class="o">=</span> <span class="n">get_m3photom</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">basename</span><span class="p">)</span>
    <span class="n">refl</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">get_rad_factor</span><span class="p">(</span><span class="n">rad</span><span class="p">,</span> <span class="n">L_sun</span><span class="p">)</span> <span class="o">*</span> <span class="n">photom</span>

    <span class="c1"># Clip noisy M3 channels</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">refl</span><span class="p">,</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">):</span>
        <span class="n">refl</span> <span class="o">=</span> <span class="n">refl</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">wavelength</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">wlmin</span><span class="p">,</span> <span class="n">wlmax</span><span class="p">))</span>
        <span class="n">L_sun</span> <span class="o">=</span> <span class="n">L_sun</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">wavelength</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">wlmin</span><span class="p">,</span> <span class="n">wlmax</span><span class="p">))</span>
        <span class="n">albedo</span> <span class="o">=</span> <span class="p">(</span><span class="n">refl</span> <span class="o">*</span> <span class="n">L_sun</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="s2">&quot;wavelength&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">L_sun</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="s2">&quot;wavelength&quot;</span><span class="p">)</span>
    <span class="c1"># refl = refl[:, :, bmin:]</span>
    <span class="c1"># L_sun = L_sun[:, :, bmin:]</span>
    <span class="c1"># albedo = np.sum(refl * L_sun, axis=2) / np.sum(L_sun, axis=2)</span>
    <span class="n">albedo</span> <span class="o">=</span> <span class="n">albedo</span> <span class="o">*</span> <span class="n">factor</span>
    <span class="n">albedo</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="nb">max</span><span class="o">=</span><span class="n">amax</span><span class="p">)</span>  <span class="c1"># limit exteme albedos</span>
    <span class="k">return</span> <span class="n">albedo</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="m3_correction.get_m3photom" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_m3photom</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">basename</span><span class="p">,</span> <span class="n">newph</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">polish</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Return photometric correction factor, used to correct M3 radiance to
i=30, e=0, g=30 using the M3 photometric correction.</p>

          <details class="quote">
            <summary>Source code in <code>roughness/m3_correction.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_m3photom</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">basename</span><span class="p">,</span> <span class="n">newph</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">polish</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return photometric correction factor, used to correct M3 radiance to</span>
<span class="sd">    i=30, e=0, g=30 using the M3 photometric correction.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Limb darkening breaks down at high inc / em angle (Besse et al., 2013)</span>
    <span class="c1"># if i &gt; 85 or e &gt; 85:</span>
    <span class="c1">#     return np.ones_like(g) * np.nan</span>

    <span class="c1"># Get M3 photometry table interpolated to phase values</span>
    <span class="n">targeted</span> <span class="o">=</span> <span class="n">is_targeted</span><span class="p">(</span><span class="n">basename</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">):</span>
        <span class="n">photom</span> <span class="o">=</span> <span class="n">get_photom_xr</span><span class="p">(</span><span class="n">targeted</span><span class="p">,</span> <span class="n">newph</span><span class="p">)</span>
        <span class="n">photom30</span> <span class="o">=</span> <span class="n">photom</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">phase</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
        <span class="n">photom_g</span> <span class="o">=</span> <span class="n">photom</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">phase</span><span class="o">=</span><span class="n">g</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">phase</span><span class="p">,</span> <span class="n">photom</span> <span class="o">=</span> <span class="n">get_photom</span><span class="p">(</span><span class="n">targeted</span><span class="p">,</span> <span class="n">newph</span><span class="p">)</span>
        <span class="n">photom30</span> <span class="o">=</span> <span class="n">photom</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">phase</span> <span class="o">-</span> <span class="mi">30</span><span class="p">))]</span>
        <span class="n">photom_g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">phase</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">photom</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">norm_photom</span> <span class="o">=</span> <span class="n">photom30</span> <span class="o">/</span> <span class="n">photom_g</span>

    <span class="c1"># limb darkening Lommel-Selliger (Eq. 3, Besse et al., 2013)</span>
    <span class="n">i</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="n">ld</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
    <span class="n">ld30</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">6</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>  <span class="c1"># i=30, e=0</span>
    <span class="n">norm_ld</span> <span class="o">=</span> <span class="n">ld30</span> <span class="o">/</span> <span class="n">ld</span>

    <span class="c1"># Get M3 spectral polish</span>
    <span class="k">if</span> <span class="n">polish</span><span class="p">:</span>
        <span class="n">iswarm</span> <span class="o">=</span> <span class="n">get_m3_warm</span><span class="p">(</span><span class="n">basename</span><span class="p">)</span>
        <span class="n">spec_polish</span> <span class="o">=</span> <span class="n">get_polish</span><span class="p">(</span><span class="n">targeted</span><span class="p">,</span> <span class="n">iswarm</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">spec_polish</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">photom_corr</span> <span class="o">=</span> <span class="n">norm_ld</span> <span class="o">*</span> <span class="n">norm_photom</span> <span class="o">*</span> <span class="n">spec_polish</span>  <span class="c1"># * np.pi</span>
    <span class="k">return</span> <span class="n">photom_corr</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="m3_correction.get_m3xr" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_m3xr</span><span class="p">(</span><span class="n">basename</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">usgs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">dask</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xoak</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Return m3 img (rad/ref/obs/sup/loc) as lazy loaded xarray.</p>

          <details class="quote">
            <summary>Source code in <code>roughness/m3_correction.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_m3xr</span><span class="p">(</span><span class="n">basename</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">usgs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">dask</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xoak</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return m3 img (rad/ref/obs/sup/loc) as lazy loaded xarray.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">hdr</span> <span class="o">=</span> <span class="n">get_m3_headers</span><span class="p">(</span><span class="n">basename</span><span class="p">,</span> <span class="n">imgs</span><span class="o">=</span><span class="n">img</span><span class="p">,</span> <span class="n">usgs</span><span class="o">=</span><span class="n">usgs</span><span class="p">)</span>
    <span class="n">fimg</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">hdr</span><span class="p">)</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.IMG&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">fimg</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="n">fimg</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">hdr</span><span class="p">)</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.img&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dask</span> <span class="ow">and</span> <span class="n">chunks</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Chunk along y (lines), never bands (efficient spectral operations)</span>
        <span class="c1"># x (samples) usually 304 or 608 so chunking along x unnecessary</span>
        <span class="n">chunks</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;band&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
    <span class="n">chunks</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">da</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataarray</span><span class="p">(</span>
        <span class="n">fimg</span><span class="p">,</span>
        <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;rasterio&quot;</span><span class="p">,</span>
        <span class="n">parse_coordinates</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">chunks</span><span class="o">=</span><span class="n">chunks</span><span class="p">,</span>
        <span class="n">drop_variables</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;spatial_ref&quot;</span><span class="p">],</span>
        <span class="n">default_name</span><span class="o">=</span><span class="n">img</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">img</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;rad&quot;</span><span class="p">,</span> <span class="s2">&quot;ref&quot;</span><span class="p">):</span>
        <span class="n">da</span> <span class="o">=</span> <span class="n">bands2wls</span><span class="p">(</span><span class="n">da</span><span class="p">,</span> <span class="n">basename</span><span class="p">)</span>

    <span class="c1"># Not all attrs useful, some don&#39;t parse well from envi header</span>
    <span class="n">da</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">da</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">DROP_ATTRS</span><span class="p">}</span>
    <span class="n">da</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;basename&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">basename</span>
    <span class="n">da</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;fimg&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fimg</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span>

    <span class="c1"># Set up lat / lon coords from loc backplane (if loc this is redundant)</span>
    <span class="k">if</span> <span class="n">img</span> <span class="o">==</span> <span class="s2">&quot;loc&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">da</span>
    <span class="n">da</span> <span class="o">=</span> <span class="n">assign_loc</span><span class="p">(</span><span class="n">da</span><span class="p">,</span> <span class="n">basename</span><span class="p">,</span> <span class="n">usgs</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">xoak</span><span class="p">:</span>
        <span class="n">da</span> <span class="o">=</span> <span class="n">index_m3xoak</span><span class="p">(</span><span class="n">da</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">da</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="m3_correction.get_photom" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_photom</span><span class="p">(</span><span class="n">targeted</span><span class="p">,</span> <span class="n">newph</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">m3ancpath</span><span class="o">=</span><span class="n">M3ANCPATH</span><span class="p">,</span> <span class="n">m3apt</span><span class="o">=</span><span class="n">M3ALTPHOTOM</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-cached"><code>cached</code></small>
  </span>

</h2>


  <div class="doc doc-contents ">
  
      <p>Return solar spectrum and alpha photometry tables as arrays.</p>

          <details class="quote">
            <summary>Source code in <code>roughness/m3_correction.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_photom</span><span class="p">(</span><span class="n">targeted</span><span class="p">,</span> <span class="n">newph</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">m3ancpath</span><span class="o">=</span><span class="n">M3ANCPATH</span><span class="p">,</span> <span class="n">m3apt</span><span class="o">=</span><span class="n">M3ALTPHOTOM</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return solar spectrum and alpha photometry tables as arrays.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">targeted</span><span class="p">:</span>
        <span class="n">fphotom</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">m3apt</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;M3T20120120_RFL_F_ALPHA_HIL.TAB&quot;</span>
    <span class="k">elif</span> <span class="n">newph</span><span class="p">:</span>
        <span class="c1"># Newer photometric correction fixes 2.5-3 micron photometry (default)</span>
        <span class="n">fphotom</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">m3apt</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;M3G20120120_RFL_F_ALPHA_HIL.TAB&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Old photometric correction (artifacts &gt; 2.5 microns)</span>
        <span class="n">fphotom</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">m3ancpath</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;M3G20111109_RFL_F_ALPHA_HIL.TAB&quot;</span>

    <span class="n">photom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">fphotom</span><span class="p">,</span> <span class="n">skip_header</span><span class="o">=</span><span class="mi">1</span><span class="p">)[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">phase</span> <span class="o">=</span> <span class="n">photom</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">photom</span> <span class="o">=</span> <span class="n">photom</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">:]</span>
    <span class="k">return</span> <span class="n">phase</span><span class="p">,</span> <span class="n">photom</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="m3_correction.get_photom_xr" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_photom_xr</span><span class="p">(</span><span class="n">targeted</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Return xarray m3 photom</p>

          <details class="quote">
            <summary>Source code in <code>roughness/m3_correction.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_photom_xr</span><span class="p">(</span><span class="n">targeted</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return xarray m3 photom&quot;&quot;&quot;</span>
    <span class="n">phase</span><span class="p">,</span> <span class="n">photom</span> <span class="o">=</span> <span class="n">get_photom</span><span class="p">(</span><span class="n">targeted</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">photom</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
        <span class="n">photom</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span>
        <span class="n">coords</span><span class="o">=</span><span class="p">[</span>
            <span class="p">(</span><span class="s2">&quot;phase&quot;</span><span class="p">,</span> <span class="n">phase</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()),</span>
            <span class="p">(</span><span class="s2">&quot;wavelength&quot;</span><span class="p">,</span> <span class="n">get_m3_wls</span><span class="p">(</span><span class="n">targeted</span><span class="p">)),</span>
        <span class="p">],</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">photom</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="m3_correction.get_polish" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_polish</span><span class="p">(</span><span class="n">targeted</span><span class="p">,</span> <span class="n">iswarm</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">m3ancpath</span><span class="o">=</span><span class="n">M3ANCPATH</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-cached"><code>cached</code></small>
  </span>

</h2>


  <div class="doc doc-contents ">
  
      <p>Return polish based on whether the detector was warm or cold.</p>
<h4 id="m3_correction.get_polish--returns">Returns</h4>
<p>polish_arr (np 1x1xN array)</p>

          <details class="quote">
            <summary>Source code in <code>roughness/m3_correction.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_polish</span><span class="p">(</span><span class="n">targeted</span><span class="p">,</span> <span class="n">iswarm</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">m3ancpath</span><span class="o">=</span><span class="n">M3ANCPATH</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return polish based on whether the detector was warm or cold.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    polish_arr (np 1x1xN array)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">iswarm</span> <span class="ow">and</span> <span class="n">targeted</span><span class="p">:</span>
        <span class="n">fp</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">m3ancpath</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;targeted&quot;</span> <span class="o">/</span> <span class="s2">&quot;M3T20111020_RFL_STAT_POL_2.TAB&quot;</span>
    <span class="k">elif</span> <span class="n">iswarm</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">targeted</span><span class="p">:</span>
        <span class="n">fp</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">m3ancpath</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;M3G20110830_RFL_STAT_POL_2.TAB&quot;</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">iswarm</span> <span class="ow">and</span> <span class="n">targeted</span><span class="p">:</span>
        <span class="n">fp</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">m3ancpath</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;targeted&quot;</span> <span class="o">/</span> <span class="s2">&quot;M3T20111020_RFL_STAT_POL_1.TAB&quot;</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">iswarm</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">targeted</span><span class="p">:</span>
        <span class="n">fp</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">m3ancpath</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;M3G20110830_RFL_STAT_POL_1.TAB&quot;</span>
    <span class="n">polish_table</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
    <span class="n">polish_arr</span> <span class="o">=</span> <span class="n">polish_table</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">polish_table</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">polish_arr</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="m3_correction.get_polish_xr" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_polish_xr</span><span class="p">(</span><span class="n">targeted</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Return xarray polish</p>

          <details class="quote">
            <summary>Source code in <code>roughness/m3_correction.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_polish_xr</span><span class="p">(</span><span class="n">targeted</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return xarray polish&quot;&quot;&quot;</span>
    <span class="n">polish</span> <span class="o">=</span> <span class="n">get_polish</span><span class="p">(</span><span class="n">targeted</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
    <span class="n">polish</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
        <span class="n">polish</span><span class="p">,</span>
        <span class="n">coords</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;wavelength&quot;</span><span class="p">,</span> <span class="n">get_m3_wls</span><span class="p">(</span><span class="n">targeted</span><span class="p">))],</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">polish</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="m3_correction.get_solar_dist" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_solar_dist</span><span class="p">(</span><span class="n">basename</span><span class="p">,</span> <span class="n">obs</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Get the solar distance subtracted off of M3 obs band 6.</p>

          <details class="quote">
            <summary>Source code in <code>roughness/m3_correction.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_solar_dist</span><span class="p">(</span><span class="n">basename</span><span class="p">,</span> <span class="n">obs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the solar distance subtracted off of M3 obs band 6.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">obs_header</span> <span class="o">=</span> <span class="n">get_m3_headers</span><span class="p">(</span><span class="n">basename</span><span class="p">,</span> <span class="n">imgs</span><span class="o">=</span><span class="s2">&quot;obs&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">obs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">obs</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">read_m3_image</span><span class="p">(</span><span class="n">obs_header</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[:,</span> <span class="p">:,</span> <span class="mi">5</span><span class="p">])</span>
    <span class="n">sdist</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">parse_envi_header</span><span class="p">(</span><span class="n">obs_header</span><span class="p">)</span>
        <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">])</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">description</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;(au)&quot;</span><span class="p">)</span>
        <span class="n">sdist</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">description</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">6</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">16</span><span class="p">])</span>
    <span class="k">except</span> <span class="ne">FileNotFoundError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">w</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Could not get sdist for </span><span class="si">{</span><span class="n">obs_header</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">):</span>
        <span class="n">solar_dist</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">band</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;band&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">sdist</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">solar_dist</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="n">sdist</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">solar_dist</span> <span class="o">=</span> <span class="n">obs</span> <span class="o">+</span> <span class="n">sdist</span>
    <span class="k">return</span> <span class="n">solar_dist</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="m3_correction.get_solar_irradiance_xr" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_solar_irradiance_xr</span><span class="p">(</span><span class="n">basename</span><span class="p">,</span> <span class="n">obs</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Return m3 solar spectrum normalized by solar distance [W/(m^2 um)].</p>

          <details class="quote">
            <summary>Source code in <code>roughness/m3_correction.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_solar_irradiance_xr</span><span class="p">(</span><span class="n">basename</span><span class="p">,</span> <span class="n">obs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return m3 solar spectrum normalized by solar distance [W/(m^2 um)].&quot;&quot;&quot;</span>
    <span class="n">solar_dist</span> <span class="o">=</span> <span class="n">get_solar_dist</span><span class="p">(</span><span class="n">basename</span><span class="p">,</span> <span class="n">obs</span><span class="p">)</span>
    <span class="n">solar_spec</span> <span class="o">=</span> <span class="n">get_solar_spectrum_xr</span><span class="p">(</span><span class="n">basename</span><span class="p">)</span>
    <span class="n">L_sun</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">get_solar_irradiance</span><span class="p">(</span><span class="n">solar_spec</span><span class="p">,</span> <span class="n">solar_dist</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">L_sun</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="m3_correction.get_solar_spectrum" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_solar_spectrum</span><span class="p">(</span><span class="n">targeted</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">m3ancpath</span><span class="o">=</span><span class="n">M3ANCPATH</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-cached"><code>cached</code></small>
  </span>

</h2>


  <div class="doc doc-contents ">
  
      <p>Return m3 solar spectrum [W/(m^2 um)].</p>

          <details class="quote">
            <summary>Source code in <code>roughness/m3_correction.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@lru_cache</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_solar_spectrum</span><span class="p">(</span><span class="n">targeted</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">m3ancpath</span><span class="o">=</span><span class="n">M3ANCPATH</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return m3 solar spectrum [W/(m^2 um)].&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">targeted</span><span class="p">:</span>
        <span class="n">fss</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">m3ancpath</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;targeted&quot;</span> <span class="o">/</span> <span class="s2">&quot;M3T20110224_RFL_SOLAR_SPEC.TAB&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fss</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">m3ancpath</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;M3G20110224_RFL_SOLAR_SPEC.TAB&quot;</span>
    <span class="n">ss_raw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">fss</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
    <span class="n">ss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">ss_raw</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ss</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="m3_correction.get_solar_spectrum_xr" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_solar_spectrum_xr</span><span class="p">(</span><span class="n">basename</span><span class="p">,</span> <span class="n">m3ancpath</span><span class="o">=</span><span class="n">M3ANCPATH</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Return m3 solar spectrum [W/(m^2 um)].</p>

          <details class="quote">
            <summary>Source code in <code>roughness/m3_correction.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_solar_spectrum_xr</span><span class="p">(</span><span class="n">basename</span><span class="p">,</span> <span class="n">m3ancpath</span><span class="o">=</span><span class="n">M3ANCPATH</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return m3 solar spectrum [W/(m^2 um)].&quot;&quot;&quot;</span>
    <span class="n">ss</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
        <span class="n">get_solar_spectrum</span><span class="p">(</span><span class="n">is_targeted</span><span class="p">(</span><span class="n">basename</span><span class="p">),</span> <span class="n">m3ancpath</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span>
        <span class="n">coords</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;wavelength&quot;</span><span class="p">,</span> <span class="n">get_m3_wls</span><span class="p">(</span><span class="n">basename</span><span class="p">))],</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">ss</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="m3_correction.get_spec" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_spec</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">wlmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">wlmax</span><span class="o">=</span><span class="mf">100000.0</span><span class="p">,</span> <span class="n">wls</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Return the wavelengths and spectrum of a 1D arr (1 pixel) of M3 data
Optionally specify min and max wavelengths to crop spectrum</p>

          <details class="quote">
            <summary>Source code in <code>roughness/m3_correction.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1324</span>
<span class="normal">1325</span>
<span class="normal">1326</span>
<span class="normal">1327</span>
<span class="normal">1328</span>
<span class="normal">1329</span>
<span class="normal">1330</span>
<span class="normal">1331</span>
<span class="normal">1332</span>
<span class="normal">1333</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_spec</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">wlmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">wlmax</span><span class="o">=</span><span class="mf">1e5</span><span class="p">,</span> <span class="n">wls</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the wavelengths and spectrum of a 1D arr (1 pixel) of M3 data</span>
<span class="sd">    Optionally specify min and max wavelengths to crop spectrum&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">wls</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">wls</span> <span class="o">=</span> <span class="n">get_m3_wls</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
    <span class="n">bmin</span><span class="p">,</span> <span class="n">wlmin</span> <span class="o">=</span> <span class="n">wl_to_ind</span><span class="p">(</span><span class="n">wlmin</span><span class="p">,</span> <span class="n">wls</span><span class="p">)</span>
    <span class="n">bmax</span><span class="p">,</span> <span class="n">wlmax</span> <span class="o">=</span> <span class="n">wl_to_ind</span><span class="p">(</span><span class="n">wlmax</span><span class="p">,</span> <span class="n">wls</span><span class="p">)</span>
    <span class="n">wls</span> <span class="o">=</span> <span class="n">wls</span><span class="p">[</span><span class="n">bmin</span> <span class="p">:</span> <span class="n">bmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">spec</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="n">bmin</span> <span class="p">:</span> <span class="n">bmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">wls</span><span class="p">,</span> <span class="n">spec</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="m3_correction.get_tloc_range_spice" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_tloc_range_spice</span><span class="p">(</span><span class="n">basename</span><span class="p">,</span> <span class="n">minlon</span><span class="p">,</span> <span class="n">maxlon</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Return M3 min and max local time using spice.
Gets start and end times from label file if found, else takes timestamp
from the basename. In future could read actual times from TIM files
(but range usually &lt;0.1 lst for a given image).</p>

          <details class="quote">
            <summary>Source code in <code>roughness/m3_correction.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1211</span>
<span class="normal">1212</span>
<span class="normal">1213</span>
<span class="normal">1214</span>
<span class="normal">1215</span>
<span class="normal">1216</span>
<span class="normal">1217</span>
<span class="normal">1218</span>
<span class="normal">1219</span>
<span class="normal">1220</span>
<span class="normal">1221</span>
<span class="normal">1222</span>
<span class="normal">1223</span>
<span class="normal">1224</span>
<span class="normal">1225</span>
<span class="normal">1226</span>
<span class="normal">1227</span>
<span class="normal">1228</span>
<span class="normal">1229</span>
<span class="normal">1230</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_tloc_range_spice</span><span class="p">(</span><span class="n">basename</span><span class="p">,</span> <span class="n">minlon</span><span class="p">,</span> <span class="n">maxlon</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return M3 min and max local time using spice.</span>
<span class="sd">    Gets start and end times from label file if found, else takes timestamp</span>
<span class="sd">    from the basename. In future could read actual times from TIM files</span>
<span class="sd">    (but range usually &lt;0.1 lst for a given image).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lons</span> <span class="o">=</span> <span class="p">[</span><span class="n">minlon</span><span class="p">,</span> <span class="n">maxlon</span><span class="p">]</span> <span class="k">if</span> <span class="n">maxlon</span> <span class="k">else</span> <span class="p">[</span><span class="n">minlon</span><span class="p">]</span>
    <span class="c1"># Try to read time from M3 label file, if exists, else infer from basename</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">lbl</span> <span class="o">=</span> <span class="n">get_m3_headers</span><span class="p">(</span><span class="n">basename</span><span class="p">,</span> <span class="n">imgs</span><span class="o">=</span><span class="s2">&quot;lbl&quot;</span><span class="p">)</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="n">parse_envi_header</span><span class="p">(</span><span class="n">lbl</span><span class="p">)</span>
        <span class="n">utcs</span> <span class="o">=</span> <span class="p">[</span><span class="n">meta</span><span class="p">[</span><span class="s2">&quot;START_TIME&quot;</span><span class="p">],</span> <span class="n">meta</span><span class="p">[</span><span class="s2">&quot;STOP_TIME&quot;</span><span class="p">]]</span>
    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
        <span class="n">utcs</span> <span class="o">=</span> <span class="p">[</span><span class="n">m3basename2utc</span><span class="p">(</span><span class="n">basename</span><span class="p">)]</span>
    <span class="n">tlocs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">utc</span> <span class="ow">in</span> <span class="n">utcs</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">lon</span> <span class="ow">in</span> <span class="n">lons</span><span class="p">:</span>
            <span class="n">tlocs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lst2tloc</span><span class="p">(</span><span class="n">utc2lstmoon</span><span class="p">(</span><span class="n">utc</span><span class="p">,</span> <span class="n">lon</span><span class="p">)))</span>
    <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">tlocs</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">tlocs</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="m3_correction.ibd3um" class="doc doc-heading">
<code class="highlight language-python"><span class="n">ibd3um</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">wl1</span><span class="o">=</span><span class="mf">2.697</span><span class="p">,</span> <span class="n">wl2</span><span class="o">=</span><span class="mf">2.936</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Return 3um Integrated Band Depth from spec between (wl1, wl2).
Equation 13 (Grumpe et al., 2019).</p>

          <details class="quote">
            <summary>Source code in <code>roughness/m3_correction.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1376</span>
<span class="normal">1377</span>
<span class="normal">1378</span>
<span class="normal">1379</span>
<span class="normal">1380</span>
<span class="normal">1381</span>
<span class="normal">1382</span>
<span class="normal">1383</span>
<span class="normal">1384</span>
<span class="normal">1385</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">ibd3um</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">wl1</span><span class="o">=</span><span class="mf">2.697</span><span class="p">,</span> <span class="n">wl2</span><span class="o">=</span><span class="mf">2.936</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return 3um Integrated Band Depth from spec between (wl1, wl2).</span>
<span class="sd">    Equation 13 (Grumpe et al., 2019).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">wl1</span><span class="p">,</span> <span class="n">wl2</span> <span class="o">=</span> <span class="n">sel_nearest</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="s2">&quot;wavelength&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">wl1</span><span class="p">,</span> <span class="n">wl2</span><span class="p">))</span>
    <span class="n">spec_oh</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">wavelength</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">wl1</span><span class="p">,</span> <span class="n">wl2</span><span class="p">))</span>
    <span class="n">ibd</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">spec_oh</span><span class="p">)</span><span class="o">.</span><span class="n">integrate</span><span class="p">(</span><span class="s2">&quot;wavelength&quot;</span><span class="p">)</span>
    <span class="n">dwl</span> <span class="o">=</span> <span class="n">wl2</span> <span class="o">-</span> <span class="n">wl1</span>
    <span class="k">return</span> <span class="n">ibd</span> <span class="o">/</span> <span class="n">dwl</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="m3_correction.index_m3xoak" class="doc doc-heading">
<code class="highlight language-python"><span class="n">index_m3xoak</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">opts</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Return ds with 2D xoak index set from loc file.</p>

          <details class="quote">
            <summary>Source code in <code>roughness/m3_correction.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">index_m3xoak</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">opts</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return ds with 2D xoak index set from loc file.&quot;&quot;&quot;</span>
    <span class="c1"># Default kdtree opts (from timing global data and 300x1000 pix output)</span>
    <span class="k">if</span> <span class="n">opts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">opts</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">leafsize</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span> <span class="n">balanced_tree</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">compact_nodes</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ds</span><span class="o">.</span><span class="n">xoak</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s2">&quot;lat&quot;</span><span class="p">,</span> <span class="s2">&quot;lon&quot;</span><span class="p">],</span> <span class="s2">&quot;scipy_kdtree&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">opts</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ds</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="m3_correction.is_targeted" class="doc doc-heading">
<code class="highlight language-python"><span class="n">is_targeted</span><span class="p">(</span><span class="n">m3img</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Return True if m3img has 256 bands (targeted mode) rather than 85.</p>

          <details class="quote">
            <summary>Source code in <code>roughness/m3_correction.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">is_targeted</span><span class="p">(</span><span class="n">m3img</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return True if m3img has 256 bands (targeted mode) rather than 85.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m3img</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">m3img</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m3img</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">m3img</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;M3T&quot;</span><span class="p">)</span>  <span class="c1"># Check M3G or M3T</span>
    <span class="n">m3img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">m3img</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">m3img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">256</span>  <span class="c1"># Check if shape 85 or 256</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="m3_correction.lin_contin" class="doc doc-heading">
<code class="highlight language-python"><span class="n">lin_contin</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">wl1</span><span class="o">=</span><span class="mf">2.537</span><span class="p">,</span> <span class="n">wl2</span><span class="o">=</span><span class="mf">2.657</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Return slope and intercept of linear continuum between wl1 and wl2.</p>

          <details class="quote">
            <summary>Source code in <code>roughness/m3_correction.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1359</span>
<span class="normal">1360</span>
<span class="normal">1361</span>
<span class="normal">1362</span>
<span class="normal">1363</span>
<span class="normal">1364</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">lin_contin</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">wl1</span><span class="o">=</span><span class="mf">2.537</span><span class="p">,</span> <span class="n">wl2</span><span class="o">=</span><span class="mf">2.657</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return slope and intercept of linear continuum between wl1 and wl2.&quot;&quot;&quot;</span>
    <span class="n">wl1</span><span class="p">,</span> <span class="n">wl2</span> <span class="o">=</span> <span class="n">sel_nearest</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="s2">&quot;wavelength&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">wl1</span><span class="p">,</span> <span class="n">wl2</span><span class="p">))</span>
    <span class="n">slope</span> <span class="o">=</span> <span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">wavelength</span><span class="o">=</span><span class="n">wl2</span><span class="p">)</span> <span class="o">-</span> <span class="n">spec</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">wavelength</span><span class="o">=</span><span class="n">wl1</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">wl2</span> <span class="o">-</span> <span class="n">wl1</span><span class="p">)</span>
    <span class="n">intercept</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">wavelength</span><span class="o">=</span><span class="n">wl1</span><span class="p">)</span> <span class="o">-</span> <span class="n">slope</span> <span class="o">*</span> <span class="n">wl1</span>
    <span class="k">return</span> <span class="n">slope</span><span class="p">,</span> <span class="n">intercept</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="m3_correction.lon180" class="doc doc-heading">
<code class="highlight language-python"><span class="n">lon180</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Convert lon to (-180, 180).</p>

          <details class="quote">
            <summary>Source code in <code>roughness/m3_correction.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1252</span>
<span class="normal">1253</span>
<span class="normal">1254</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">lon180</span><span class="p">(</span><span class="n">lon</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert lon to (-180, 180).&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">lon</span> <span class="o">+</span> <span class="mi">180</span><span class="p">)</span> <span class="o">%</span> <span class="mi">360</span> <span class="o">-</span> <span class="mi">180</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="m3_correction.lon360" class="doc doc-heading">
<code class="highlight language-python"><span class="n">lon360</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Convert lon to (0, 360).</p>

          <details class="quote">
            <summary>Source code in <code>roughness/m3_correction.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1247</span>
<span class="normal">1248</span>
<span class="normal">1249</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">lon360</span><span class="p">(</span><span class="n">lon</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert lon to (0, 360).&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">lon</span> <span class="o">+</span> <span class="mi">360</span><span class="p">)</span> <span class="o">%</span> <span class="mi">360</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="m3_correction.lst2tloc" class="doc doc-heading">
<code class="highlight language-python"><span class="n">lst2tloc</span><span class="p">(</span><span class="n">lst</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Return decimal local time [hr] from lst [hr,min,sec] (spice et2lst).</p>

          <details class="quote">
            <summary>Source code in <code>roughness/m3_correction.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1206</span>
<span class="normal">1207</span>
<span class="normal">1208</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">lst2tloc</span><span class="p">(</span><span class="n">lst</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return decimal local time [hr] from lst [hr,min,sec] (spice et2lst).&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">lst</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">lst</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mi">60</span> <span class="o">+</span> <span class="n">lst</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="mi">3600</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="m3_correction.m3_refl" class="doc doc-heading">
<code class="highlight language-python"><span class="n">m3_refl</span><span class="p">(</span><span class="n">basename</span><span class="p">,</span> <span class="n">ext</span><span class="p">,</span> <span class="n">wls</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kwin</span><span class="o">=</span><span class="n">KWIN</span><span class="p">,</span> <span class="n">kwre</span><span class="o">=</span><span class="p">{})</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Return M3 reflectance using the Tai Udovicic et al (2022) roughness
thermal correction (updated from Bandfield et al., 2018).
Uses ray-casting generated shadow_lookup table, KRC temperature table and
applies standard M3 processing steps (empirical photometric correction).</p>

          <details class="quote">
            <summary>Source code in <code>roughness/m3_correction.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span>
<span class="normal">96</span>
<span class="normal">97</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">m3_refl</span><span class="p">(</span><span class="n">basename</span><span class="p">,</span> <span class="n">ext</span><span class="p">,</span> <span class="n">wls</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kwin</span><span class="o">=</span><span class="n">KWIN</span><span class="p">,</span> <span class="n">kwre</span><span class="o">=</span><span class="p">{}):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return M3 reflectance using the Tai Udovicic et al (2022) roughness</span>
<span class="sd">    thermal correction (updated from Bandfield et al., 2018).</span>
<span class="sd">    Uses ray-casting generated shadow_lookup table, KRC temperature table and</span>
<span class="sd">    applies standard M3 processing steps (empirical photometric correction).</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">chunks</span> <span class="o">=</span> <span class="n">kwin</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;chunks&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">kwin</span><span class="p">[</span><span class="s2">&quot;dask&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">obs</span> <span class="o">=</span> <span class="n">subset_m3xr_ext</span><span class="p">(</span><span class="n">get_m3xr</span><span class="p">(</span><span class="n">basename</span><span class="p">,</span> <span class="s2">&quot;obs&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwin</span><span class="p">),</span> <span class="n">ext</span><span class="p">)</span>
    <span class="n">alb</span> <span class="o">=</span> <span class="n">get_albedo_feng</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span> <span class="n">obs</span><span class="o">.</span><span class="n">lat</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ext</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">ext</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nb">float</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="n">obs</span><span class="o">.</span><span class="n">lon</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span>
                <span class="n">obs</span><span class="o">.</span><span class="n">lon</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
                <span class="n">obs</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span>
                <span class="n">obs</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
            <span class="p">)</span>
        <span class="p">]</span>
    <span class="n">tloc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">get_tloc_range_spice</span><span class="p">(</span><span class="n">basename</span><span class="p">,</span> <span class="n">ext</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ext</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">ls</span> <span class="o">=</span> <span class="n">get_ls_spice</span><span class="p">(</span><span class="n">basename</span><span class="p">)</span>  <span class="c1"># Solar longitude (L_s)</span>
    <span class="n">wls</span> <span class="o">=</span> <span class="n">get_m3_wls</span><span class="p">(</span><span class="n">basename</span><span class="p">)</span> <span class="k">if</span> <span class="n">wls</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">wls</span>
    <span class="n">wls</span> <span class="o">=</span> <span class="n">rh</span><span class="o">.</span><span class="n">wl2xr</span><span class="p">(</span><span class="n">wls</span><span class="p">)</span>

    <span class="c1"># Get rough emission</span>
    <span class="n">i</span><span class="p">,</span> <span class="n">iaz</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">eaz</span><span class="p">,</span> <span class="n">g</span> <span class="o">=</span> <span class="n">get_m3_geom_xr</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># TODO: dem</span>
    <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">iaz</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">eaz</span><span class="p">,</span> <span class="n">alb</span><span class="p">,</span> <span class="n">wls</span><span class="p">,</span> <span class="n">tloc</span><span class="p">,</span> <span class="n">ls</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">chunks</span><span class="p">:</span>
        <span class="c1"># emission = xr.map_blocks(get_emission_xr, i, args, kwre, template=(i*wls))</span>
        <span class="c1"># emission = emission.load()  # Compute emission on chunks with dask</span>
        <span class="n">chunks</span><span class="p">[</span><span class="s2">&quot;wavelength&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">chunks</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;band&quot;</span><span class="p">)</span>
        <span class="n">emission</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="n">wls</span><span class="p">)</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="n">chunks</span><span class="p">)</span>
        <span class="n">emission</span> <span class="o">=</span> <span class="n">map_blocks</span><span class="p">(</span>
            <span class="n">emission_xr_helper</span><span class="p">,</span> <span class="n">emission</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">ind_dims</span><span class="o">=</span><span class="n">i</span><span class="o">.</span><span class="n">dims</span><span class="p">,</span> <span class="o">**</span><span class="n">kwre</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">emission</span> <span class="o">=</span> <span class="n">get_emission_xr</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwre</span><span class="p">)</span>
    <span class="n">emission</span> <span class="o">=</span> <span class="n">emission</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span>
        <span class="s2">&quot;wavelength&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span>
    <span class="p">)</span>  <span class="c1"># TODO check order earlier</span>

    <span class="c1"># Remove emission from rad and convert to I/F</span>
    <span class="n">rad</span> <span class="o">=</span> <span class="n">subset_m3xr_ext</span><span class="p">(</span><span class="n">get_m3xr</span><span class="p">(</span><span class="n">basename</span><span class="p">,</span> <span class="s2">&quot;rad&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwin</span><span class="p">),</span> <span class="n">ext</span><span class="p">)</span>
    <span class="n">L_sun</span> <span class="o">=</span> <span class="n">get_solar_irradiance_xr</span><span class="p">(</span><span class="n">basename</span><span class="p">,</span> <span class="n">obs</span><span class="p">)</span>
    <span class="n">photom</span> <span class="o">=</span> <span class="n">get_m3photom</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">basename</span><span class="p">)</span>
    <span class="n">refl</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">get_rad_factor</span><span class="p">(</span><span class="n">rad</span><span class="p">,</span> <span class="n">L_sun</span><span class="p">,</span> <span class="n">emission</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">photom</span>
    <span class="n">refl</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">rad</span><span class="o">.</span><span class="n">attrs</span>
    <span class="k">return</span> <span class="n">refl</span><span class="p">,</span> <span class="n">emission</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="m3_correction.m3_size_est" class="doc doc-heading">
<code class="highlight language-python"><span class="n">m3_size_est</span><span class="p">(</span><span class="n">basename</span><span class="p">,</span> <span class="n">ext</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Return estimates number of pixels from M3img name and extent.</p>

          <details class="quote">
            <summary>Source code in <code>roughness/m3_correction.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">926</span>
<span class="normal">927</span>
<span class="normal">928</span>
<span class="normal">929</span>
<span class="normal">930</span>
<span class="normal">931</span>
<span class="normal">932</span>
<span class="normal">933</span>
<span class="normal">934</span>
<span class="normal">935</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">m3_size_est</span><span class="p">(</span><span class="n">basename</span><span class="p">,</span> <span class="n">ext</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return estimates number of pixels from M3img name and extent.&quot;&quot;&quot;</span>
    <span class="n">mpp_res</span> <span class="o">=</span> <span class="n">get_m3_res</span><span class="p">(</span><span class="n">basename</span><span class="p">)</span>
    <span class="n">ppd_res</span> <span class="o">=</span> <span class="n">mpp2ppd</span><span class="p">(</span><span class="n">mpp_res</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ext</span><span class="p">[</span><span class="mi">2</span><span class="p">:]))</span>
    <span class="n">xsize</span> <span class="o">=</span> <span class="n">ppd_res</span> <span class="o">*</span> <span class="p">(</span><span class="n">ext</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ext</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">ysize</span> <span class="o">=</span> <span class="n">ppd_res</span> <span class="o">*</span> <span class="p">(</span><span class="n">ext</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">ext</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">zsize</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">get_m3_wls</span><span class="p">(</span><span class="n">basename</span><span class="p">))</span>
    <span class="n">pixels</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">xsize</span> <span class="o">*</span> <span class="n">ysize</span><span class="p">)</span>
    <span class="n">data_size</span> <span class="o">=</span> <span class="n">pixels</span> <span class="o">*</span> <span class="n">zsize</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">/</span> <span class="mf">1e6</span>  <span class="c1"># MB assuming 8 bit float</span>
    <span class="k">return</span> <span class="n">pixels</span><span class="p">,</span> <span class="n">data_size</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="m3_correction.m3_wl_to_ind" class="doc doc-heading">
<code class="highlight language-python"><span class="n">m3_wl_to_ind</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">img</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Get index and nearest wavelength of img given wl in nanometers.</p>

          <details class="quote">
            <summary>Source code in <code>roughness/m3_correction.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1281</span>
<span class="normal">1282</span>
<span class="normal">1283</span>
<span class="normal">1284</span>
<span class="normal">1285</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">m3_wl_to_ind</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">img</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get index and nearest wavelength of img given wl in nanometers.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">wl_to_ind</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">get_m3_wls</span><span class="p">(</span><span class="n">img</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="m3_correction.m3basename2utc" class="doc doc-heading">
<code class="highlight language-python"><span class="n">m3basename2utc</span><span class="p">(</span><span class="n">basename</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">T%H:%M:%S&#39;</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Return UTC time from m3 basename.</p>

          <details class="quote">
            <summary>Source code in <code>roughness/m3_correction.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1166</span>
<span class="normal">1167</span>
<span class="normal">1168</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">m3basename2utc</span><span class="p">(</span><span class="n">basename</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%S&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return UTC time from m3 basename.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">get_m3_date</span><span class="p">(</span><span class="n">basename</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">fmt</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="m3_correction.map_blocks" class="doc doc-heading">
<code class="highlight language-python"><span class="n">map_blocks</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">outda</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">ind_dims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Map func to blocks of args.</p>

          <details class="quote">
            <summary>Source code in <code>roughness/m3_correction.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">map_blocks</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">outda</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">ind_dims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Map func to blocks of args.&quot;&quot;&quot;</span>
    <span class="c1"># Magic to get dask chunk slices as list of multiple indices</span>
    <span class="k">if</span> <span class="n">ind_dims</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ind_dims</span> <span class="o">=</span> <span class="n">outda</span><span class="o">.</span><span class="n">dims</span>
    <span class="n">cranges</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">dim</span><span class="p">,</span> <span class="n">chunks</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">outda</span><span class="o">.</span><span class="n">dims</span><span class="p">,</span> <span class="n">outda</span><span class="o">.</span><span class="n">chunks</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">ind_dims</span><span class="p">:</span>
            <span class="n">cedges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">chunks</span><span class="p">)]</span>
            <span class="n">cranges</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">cedges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">cedges</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>
    <span class="n">inds</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nb">tuple</span><span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="o">*</span><span class="n">ind</span><span class="p">)</span> <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">inds</span><span class="p">)</span> <span class="k">for</span> <span class="n">inds</span> <span class="ow">in</span> <span class="n">it</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="o">*</span><span class="n">cranges</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="c1"># Run in parallel</span>
    <span class="k">with</span> <span class="n">mp</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">NCPUS</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
        <span class="n">args</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">inds</span><span class="p">,</span> <span class="n">it</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">args</span><span class="p">),</span> <span class="n">it</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">kwargs</span><span class="p">))</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">starmap</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># Get results</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">inds</span><span class="p">):</span>
        <span class="c1"># func(ind, args, kwargs)</span>
        <span class="n">outda</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">outda</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="m3_correction.mpp2ppd" class="doc doc-heading">
<code class="highlight language-python"><span class="n">mpp2ppd</span><span class="p">(</span><span class="n">mpp</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">Rmoon</span><span class="o">=</span><span class="mf">1737.4</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Convert lunar meters / pixel to pixels / degree resolution at lat.</p>

          <details class="quote">
            <summary>Source code in <code>roughness/m3_correction.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">956</span>
<span class="normal">957</span>
<span class="normal">958</span>
<span class="normal">959</span>
<span class="normal">960</span>
<span class="normal">961</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">mpp2ppd</span><span class="p">(</span><span class="n">mpp</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">Rmoon</span><span class="o">=</span><span class="mf">1737.4</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert lunar meters / pixel to pixels / degree resolution at lat.&quot;&quot;&quot;</span>
    <span class="n">circum_eq</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">Rmoon</span> <span class="o">*</span> <span class="mi">1000</span>  <span class="c1"># m</span>
    <span class="n">circum_lat</span> <span class="o">=</span> <span class="n">circum_eq</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span>
    <span class="n">ppd</span> <span class="o">=</span> <span class="p">(</span><span class="n">circum_lat</span> <span class="o">/</span> <span class="n">mpp</span><span class="p">)</span> <span class="o">/</span> <span class="mi">360</span>
    <span class="k">return</span> <span class="n">ppd</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="m3_correction.parse_envi_header" class="doc doc-heading">
<code class="highlight language-python"><span class="n">parse_envi_header</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Return dictionary of parameters in the envi header.</p>
<p>TODO: port to open planetary package</p>

          <details class="quote">
            <summary>Source code in <code>roughness/m3_correction.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">parse_envi_header</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return dictionary of parameters in the envi header.</span>

<span class="sd">    TODO: port to open planetary package</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">line</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">if</span> <span class="s2">&quot;}&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="n">value</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>  <span class="c1"># pylint: disable=E1101</span>
                        <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;}&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="p">)</span>
                    <span class="n">params</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">value</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot; </span><span class="se">\t\n</span><span class="s2">,&quot;</span><span class="p">))</span>
            <span class="k">elif</span> <span class="s2">&quot;=&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)</span>
                <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="s2">&quot;{&quot;</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">elif</span> <span class="s2">&quot;DESCRIPTION&quot;</span> <span class="ow">in</span> <span class="n">key</span> <span class="ow">and</span> <span class="n">line</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># Parse multi-line description</span>
                    <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="p">]</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
                    <span class="k">while</span> <span class="n">line</span> <span class="ow">and</span> <span class="n">line</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                        <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
                    <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                    <span class="n">params</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">params</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">params</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="m3_correction.read_albedo_map_feng" class="doc doc-heading">
<code class="highlight language-python"><span class="n">read_albedo_map_feng</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">falbedo</span><span class="o">=</span><span class="n">FALBEDO</span><span class="p">,</span> <span class="n">amin</span><span class="o">=</span><span class="mf">0.04</span><span class="p">,</span> <span class="n">amax</span><span class="o">=</span><span class="mf">0.22</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Return normal bolometric bond albedo albedo map from Feng et al. (2020).</p>
<p>https://doi.org/10.5281/zenodo.3575481</p>

          <details class="quote">
            <summary>Source code in <code>roughness/m3_correction.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">read_albedo_map_feng</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">falbedo</span><span class="o">=</span><span class="n">FALBEDO</span><span class="p">,</span> <span class="n">amin</span><span class="o">=</span><span class="mf">0.04</span><span class="p">,</span> <span class="n">amax</span><span class="o">=</span><span class="mf">0.22</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return normal bolometric bond albedo albedo map from Feng et al. (2020).</span>

<span class="sd">    https://doi.org/10.5281/zenodo.3575481</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">falbedo</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;\s+&quot;</span><span class="p">)</span>
    <span class="n">lats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">90</span><span class="p">,</span> <span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))</span>
    <span class="n">lon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">180</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>
    <span class="n">albmap</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="p">[</span><span class="n">lats</span><span class="p">,</span> <span class="n">lon</span><span class="p">],</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">,</span> <span class="s2">&quot;lon&quot;</span><span class="p">])</span>
    <span class="n">albmap</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;albedo&quot;</span>
    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="n">albmap</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">albmap</span><span class="o">.</span><span class="n">lon</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">albmap</span><span class="o">.</span><span class="n">lat</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">albmap</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">amin</span><span class="p">,</span> <span class="n">amax</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="m3_correction.read_m3_geotiff" class="doc doc-heading">
<code class="highlight language-python"><span class="n">read_m3_geotiff</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">ext</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Return M3 image from file f with extent ext using rasterio.</p>
<h4 id="m3_correction.read_m3_geotiff--parameters">Parameters</h4>
<p>f (str): path to file
ext (tuple): (latmin, latmax, lonmin, lonmax)
pad (bool): pad image to match extent of ext</p>

          <details class="quote">
            <summary>Source code in <code>roughness/m3_correction.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">882</span>
<span class="normal">883</span>
<span class="normal">884</span>
<span class="normal">885</span>
<span class="normal">886</span>
<span class="normal">887</span>
<span class="normal">888</span>
<span class="normal">889</span>
<span class="normal">890</span>
<span class="normal">891</span>
<span class="normal">892</span>
<span class="normal">893</span>
<span class="normal">894</span>
<span class="normal">895</span>
<span class="normal">896</span>
<span class="normal">897</span>
<span class="normal">898</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">read_m3_geotiff</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">ext</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return M3 image from file f with extent ext using rasterio.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    f (str): path to file</span>
<span class="sd">    ext (tuple): (latmin, latmax, lonmin, lonmax)</span>
<span class="sd">    pad (bool): pad image to match extent of ext</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">bot</span><span class="p">,</span> <span class="n">top</span> <span class="o">=</span> <span class="n">ext</span>
    <span class="k">with</span> <span class="n">rio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">rio</span><span class="o">.</span><span class="n">windows</span><span class="o">.</span><span class="n">from_bounds</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">bot</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">top</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">transform</span><span class="p">)</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">rio2xy</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">w</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">pad</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">rio_pad</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">ext</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">transform</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">img</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="m3_correction.read_m3_geotiff_ext" class="doc doc-heading">
<code class="highlight language-python"><span class="n">read_m3_geotiff_ext</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">ext</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Read M3 geotiff with ext (minlon, maxlon, minlat, maxlat)</p>

          <details class="quote">
            <summary>Source code in <code>roughness/m3_correction.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">914</span>
<span class="normal">915</span>
<span class="normal">916</span>
<span class="normal">917</span>
<span class="normal">918</span>
<span class="normal">919</span>
<span class="normal">920</span>
<span class="normal">921</span>
<span class="normal">922</span>
<span class="normal">923</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">read_m3_geotiff_ext</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">ext</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Read M3 geotiff with ext (minlon, maxlon, minlat, maxlat)&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">rio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">ext2window</span><span class="p">(</span><span class="n">ext</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">transform</span><span class="p">)</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">rio2xy</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">rio_pad</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">ext</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">transform</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">src</span><span class="o">.</span><span class="n">count</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">img</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="m3_correction.read_m3_image" class="doc doc-heading">
<code class="highlight language-python"><span class="n">read_m3_image</span><span class="p">(</span><span class="n">hdr_path</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">xmax</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Return np.array() with subset of m3 image with rasterio. Assumes the
image is in the same directory as the header in hdr_path.</p>

          <details class="quote">
            <summary>Source code in <code>roughness/m3_correction.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">read_m3_image</span><span class="p">(</span><span class="n">hdr_path</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">xmax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return np.array() with subset of m3 image with rasterio. Assumes the</span>
<span class="sd">    image is in the same directory as the header in hdr_path.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ext</span> <span class="o">=</span> <span class="s2">&quot;.IMG&quot;</span> <span class="k">if</span> <span class="n">hdr_path</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">isupper</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;.img&quot;</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="n">hdr_path</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="n">ext</span>
    <span class="k">with</span> <span class="n">rio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="n">rwindow</span> <span class="o">=</span> <span class="n">rio</span><span class="o">.</span><span class="n">windows</span><span class="o">.</span><span class="n">Window</span><span class="o">.</span><span class="n">from_slices</span><span class="p">(</span>
            <span class="p">(</span><span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">),</span> <span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">),</span> <span class="n">width</span><span class="o">=</span><span class="n">src</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">src</span><span class="o">.</span><span class="n">height</span>
        <span class="p">)</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">rio2xy</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">rwindow</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">img</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="m3_correction.read_m3_rois" class="doc doc-heading">
<code class="highlight language-python"><span class="n">read_m3_rois</span><span class="p">(</span><span class="n">roi_path</span><span class="p">,</span> <span class="n">sort_by_size</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Return dict of rois from roi_path.</p>

          <details class="quote">
            <summary>Source code in <code>roughness/m3_correction.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">read_m3_rois</span><span class="p">(</span><span class="n">roi_path</span><span class="p">,</span> <span class="n">sort_by_size</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return dict of rois from roi_path.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">roi_path</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">prio</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">sort_by_size</span><span class="p">:</span>
        <span class="n">size</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">prio</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">ext</span><span class="p">,</span> <span class="o">*</span><span class="n">basenames</span> <span class="o">=</span> <span class="n">v</span>
            <span class="n">size</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">m3_size_est</span><span class="p">(</span><span class="n">basenames</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ext</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="n">k</span><span class="p">])</span>
        <span class="n">prio</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">prio</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">size</span><span class="p">)}</span>
    <span class="k">return</span> <span class="n">prio</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="m3_correction.readm3geotif_xr" class="doc doc-heading">
<code class="highlight language-python"><span class="n">readm3geotif_xr</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">ext</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Read M3 geotiff and return xarray</p>

          <details class="quote">
            <summary>Source code in <code>roughness/m3_correction.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span>
<span class="normal">873</span>
<span class="normal">874</span>
<span class="normal">875</span>
<span class="normal">876</span>
<span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">readm3geotif_xr</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">ext</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read M3 geotiff and return xarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">da</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataarray</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;wavelength&quot;</span> <span class="ow">in</span> <span class="n">da</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
        <span class="n">wls</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">da</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;long_name&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span>
        <span class="n">da</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">wavelength</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;band&quot;</span><span class="p">,</span> <span class="n">wls</span><span class="p">))</span>
        <span class="n">da</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">swap_dims</span><span class="p">({</span><span class="s2">&quot;band&quot;</span><span class="p">:</span> <span class="s2">&quot;wavelength&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;band&quot;</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">da</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;wavelength&quot;</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">da</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;long_name&quot;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="s2">&quot;long_name&quot;</span> <span class="ow">in</span> <span class="n">da</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
        <span class="n">da</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">labels</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;band&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">da</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;long_name&quot;</span><span class="p">])))</span>
        <span class="k">del</span> <span class="n">da</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;long_name&quot;</span><span class="p">]</span>

    <span class="n">da</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="s2">&quot;lon&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="s2">&quot;lat&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">sortby</span><span class="p">(</span><span class="s2">&quot;lat&quot;</span><span class="p">)</span>
    <span class="n">da</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">lon</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">ext</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ext</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">lat</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">ext</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">ext</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">da</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s2">&quot;lat&quot;</span><span class="p">,</span> <span class="s2">&quot;lon&quot;</span><span class="p">,</span> <span class="o">*</span><span class="nb">set</span><span class="p">(</span><span class="n">da</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">({</span><span class="s2">&quot;lat&quot;</span><span class="p">,</span> <span class="s2">&quot;lon&quot;</span><span class="p">}))</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="m3_correction.rio2xy" class="doc doc-heading">
<code class="highlight language-python"><span class="n">rio2xy</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Swap axes from [(bands), rows, columns] to [x, y, (bands)].</p>

          <details class="quote">
            <summary>Source code in <code>roughness/m3_correction.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1257</span>
<span class="normal">1258</span>
<span class="normal">1259</span>
<span class="normal">1260</span>
<span class="normal">1261</span>
<span class="normal">1262</span>
<span class="normal">1263</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">rio2xy</span><span class="p">(</span><span class="n">arr</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Swap axes from [(bands), rows, columns] to [x, y, (bands)].&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">arr</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="m3_correction.rio_pad" class="doc doc-heading">
<code class="highlight language-python"><span class="n">rio_pad</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">ext</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">transform</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Zero-pad a rasterio windowed read array to shape of full extent</p>

          <details class="quote">
            <summary>Source code in <code>roughness/m3_correction.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">964</span>
<span class="normal">965</span>
<span class="normal">966</span>
<span class="normal">967</span>
<span class="normal">968</span>
<span class="normal">969</span>
<span class="normal">970</span>
<span class="normal">971</span>
<span class="normal">972</span>
<span class="normal">973</span>
<span class="normal">974</span>
<span class="normal">975</span>
<span class="normal">976</span>
<span class="normal">977</span>
<span class="normal">978</span>
<span class="normal">979</span>
<span class="normal">980</span>
<span class="normal">981</span>
<span class="normal">982</span>
<span class="normal">983</span>
<span class="normal">984</span>
<span class="normal">985</span>
<span class="normal">986</span>
<span class="normal">987</span>
<span class="normal">988</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">rio_pad</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">ext</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">transform</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Zero-pad a rasterio windowed read array to shape of full extent&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
    <span class="n">arr_width</span><span class="p">,</span> <span class="n">arr_height</span><span class="p">,</span> <span class="n">bands</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">transform</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># deg/pixel</span>
    <span class="n">wbounds</span> <span class="o">=</span> <span class="n">rio</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">array_bounds</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="n">w</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">transform</span><span class="p">)</span>
    <span class="n">ext_bounds</span> <span class="o">=</span> <span class="p">(</span><span class="n">ext</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ext</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">ext</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ext</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
    <span class="c1"># Compute bounds of full extent output image</span>
    <span class="n">ext_width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">ext_bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">ext_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">res</span><span class="p">))</span>  <span class="c1"># pixels</span>
    <span class="n">ext_height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">ext_bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">ext_bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">res</span><span class="p">))</span>  <span class="c1"># pixels</span>
    <span class="c1"># Get coords of window in extent sized image</span>
    <span class="n">ymax</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">ext_bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">wbounds</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">/</span> <span class="n">res</span><span class="p">))</span>
    <span class="n">xmin</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">wbounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">ext_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">res</span><span class="p">))</span>
    <span class="c1"># Init extent-sized output</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">ext_width</span><span class="p">,</span> <span class="n">ext_height</span><span class="p">,</span> <span class="n">bands</span><span class="p">),</span> <span class="n">fill_value</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ymax</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">xmin</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">out</span><span class="p">[</span><span class="n">xmin</span> <span class="p">:</span> <span class="n">xmin</span> <span class="o">+</span> <span class="n">arr_width</span><span class="p">,</span> <span class="n">ymax</span> <span class="p">:</span> <span class="n">ymax</span> <span class="o">+</span> <span class="n">arr_height</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">arr</span>
    <span class="k">elif</span> <span class="n">ymax</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">out</span><span class="p">[:</span><span class="n">arr_width</span><span class="p">,</span> <span class="n">ymax</span> <span class="p">:</span> <span class="n">ymax</span> <span class="o">+</span> <span class="n">arr_height</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">arr</span>
    <span class="k">elif</span> <span class="n">xmin</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">out</span><span class="p">[</span><span class="n">xmin</span> <span class="p">:</span> <span class="n">xmin</span> <span class="o">+</span> <span class="n">arr_width</span><span class="p">,</span> <span class="p">:</span><span class="n">arr_height</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">arr</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">out</span><span class="p">[:</span><span class="n">arr_width</span><span class="p">,</span> <span class="p">:</span><span class="n">arr_height</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">arr</span>
    <span class="k">return</span> <span class="n">out</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="m3_correction.sel_m3xoak" class="doc doc-heading">
<code class="highlight language-python"><span class="n">sel_m3xoak</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">lats</span><span class="p">,</span> <span class="n">lons</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Return xarray of m3 data at lats, lons using xoak index.</p>

          <details class="quote">
            <summary>Source code in <code>roughness/m3_correction.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1135</span>
<span class="normal">1136</span>
<span class="normal">1137</span>
<span class="normal">1138</span>
<span class="normal">1139</span>
<span class="normal">1140</span>
<span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span>
<span class="normal">1145</span>
<span class="normal">1146</span>
<span class="normal">1147</span>
<span class="normal">1148</span>
<span class="normal">1149</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">sel_m3xoak</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">lats</span><span class="p">,</span> <span class="n">lons</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return xarray of m3 data at lats, lons using xoak index.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">ds</span><span class="o">.</span><span class="n">xoak</span><span class="o">.</span><span class="n">index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Must have xoak index set (see index_m3_xoak).&quot;</span><span class="p">)</span>

    <span class="c1"># Make (lat, lon) xoak selector</span>
    <span class="n">sel</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;lat&quot;</span><span class="p">:</span> <span class="p">((</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">lats</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lons</span><span class="p">),</span> <span class="mi">1</span><span class="p">))),</span>
            <span class="s2">&quot;lon&quot;</span><span class="p">:</span> <span class="p">((</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">lons</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lats</span><span class="p">),</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">T</span><span class="p">),</span>
        <span class="p">}</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">ds</span><span class="o">.</span><span class="n">xoak</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">lat</span><span class="o">=</span><span class="n">sel</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="n">sel</span><span class="o">.</span><span class="n">lon</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="m3_correction.sel_nearest" class="doc doc-heading">
<code class="highlight language-python"><span class="n">sel_nearest</span><span class="p">(</span><span class="n">da</span><span class="p">,</span> <span class="n">coord</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Return nearest coord value of each x (or index of x) in xarr.</p>

          <details class="quote">
            <summary>Source code in <code>roughness/m3_correction.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1349</span>
<span class="normal">1350</span>
<span class="normal">1351</span>
<span class="normal">1352</span>
<span class="normal">1353</span>
<span class="normal">1354</span>
<span class="normal">1355</span>
<span class="normal">1356</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">sel_nearest</span><span class="p">(</span><span class="n">da</span><span class="p">,</span> <span class="n">coord</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return nearest coord value of each x (or index of x) in xarr.&quot;&quot;&quot;</span>
    <span class="n">scalar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">if</span> <span class="n">scalar</span> <span class="k">else</span> <span class="n">x</span>
    <span class="n">nearest</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
        <span class="n">nearest</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">da</span><span class="p">[</span><span class="n">coord</span><span class="p">]</span><span class="o">.</span><span class="n">sel</span><span class="p">({</span><span class="n">coord</span><span class="p">:</span> <span class="n">val</span><span class="p">},</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">nearest</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">scalar</span> <span class="k">else</span> <span class="n">nearest</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="m3_correction.subset_m3xr_ext" class="doc doc-heading">
<code class="highlight language-python"><span class="n">subset_m3xr_ext</span><span class="p">(</span><span class="n">da</span><span class="p">,</span> <span class="n">ext</span><span class="p">,</span> <span class="n">fill_bb</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Return m3 da subsetted to lat/lon ext [minlon, maxlon, minlat, maxlat].</p>

          <details class="quote">
            <summary>Source code in <code>roughness/m3_correction.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">subset_m3xr_ext</span><span class="p">(</span><span class="n">da</span><span class="p">,</span> <span class="n">ext</span><span class="p">,</span> <span class="n">fill_bb</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return m3 da subsetted to lat/lon ext [minlon, maxlon, minlat, maxlat].</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>  <span class="c1"># Dask chunk performance warning</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ext</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">subda</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">ext</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">subda</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="p">(</span><span class="n">lon360</span><span class="p">(</span><span class="n">ext</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="mi">360</span> <span class="o">&lt;=</span> <span class="n">da</span><span class="o">.</span><span class="n">lon</span> <span class="o">+</span> <span class="mi">360</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">da</span><span class="o">.</span><span class="n">lon</span> <span class="o">+</span> <span class="mi">360</span> <span class="o">&lt;=</span> <span class="n">lon360</span><span class="p">(</span><span class="n">ext</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="mi">360</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">ext</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">da</span><span class="o">.</span><span class="n">lat</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">da</span><span class="o">.</span><span class="n">lat</span> <span class="o">&lt;=</span> <span class="n">ext</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
            <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="c1"># if fill_bb: # TODO: fix</span>
    <span class="c1">#     dims = list({*da.lon.dims} | {*da.lat.dims})  # {&#39;y&#39;, &#39;x&#39;} or {&#39;lon&#39;, &#39;lat&#39;}</span>
    <span class="c1">#     dinds = [i for i, d in enumerate(subda.dims) if d in dims]</span>
    <span class="c1">#     dmin = np.min(np.where(subda.notnull()), 1)[dinds]</span>
    <span class="c1">#     dmax = np.max(np.where(subda.notnull()), 1)[dinds]</span>
    <span class="c1">#     subda = da.where(</span>
    <span class="c1">#         (dmin[0] &lt;= da[dims[0]])</span>
    <span class="c1">#         &amp; (da[dims[0]] &lt;= dmax[0])</span>
    <span class="c1">#         &amp; (dmin[1] &lt;= da[dims[1]])</span>
    <span class="c1">#         &amp; (da[dims[1]] &lt;= dmax[1]), drop=True</span>
    <span class="c1">#     )</span>
    <span class="c1"># sel = {d: slice(dmin[i], dmax[i]) for i, d in zip(dinds, dims)}</span>
    <span class="c1"># subda = da.isel(sel)</span>
    <span class="k">if</span> <span class="n">subda</span><span class="o">.</span><span class="n">chunks</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">chunks</span> <span class="o">=</span> <span class="p">{</span><span class="n">d</span><span class="p">:</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">subda</span><span class="o">.</span><span class="n">dims</span><span class="p">}</span>
        <span class="n">chunks</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span>
        <span class="n">subda</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="n">chunks</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">subda</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="m3_correction.utc2lsmoon" class="doc doc-heading">
<code class="highlight language-python"><span class="n">utc2lsmoon</span><span class="p">(</span><span class="n">utc</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Return solar longitude (L_s) [deg] from utc date using spiceypy.</p>
<p>Technically returns Earth's L_s since this is expected by KRC.</p>

          <details class="quote">
            <summary>Source code in <code>roughness/m3_correction.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1183</span>
<span class="normal">1184</span>
<span class="normal">1185</span>
<span class="normal">1186</span>
<span class="normal">1187</span>
<span class="normal">1188</span>
<span class="normal">1189</span>
<span class="normal">1190</span>
<span class="normal">1191</span>
<span class="normal">1192</span>
<span class="normal">1193</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">utc2lsmoon</span><span class="p">(</span><span class="n">utc</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return solar longitude (L_s) [deg] from utc date using spiceypy.</span>

<span class="sd">    Technically returns Earth&#39;s L_s since this is expected by KRC.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">spiceypy</span><span class="o">.</span><span class="n">ktotal</span><span class="p">(</span><span class="s2">&quot;ALL&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">furnsh_kernels</span><span class="p">()</span>
    <span class="n">et</span> <span class="o">=</span> <span class="n">spiceypy</span><span class="o">.</span><span class="n">str2et</span><span class="p">(</span><span class="n">utc</span><span class="p">)</span>
    <span class="n">ls</span> <span class="o">=</span> <span class="n">spiceypy</span><span class="o">.</span><span class="n">spiceypy</span><span class="o">.</span><span class="n">lspcn</span><span class="p">(</span><span class="s2">&quot;EARTH&quot;</span><span class="p">,</span> <span class="n">et</span><span class="p">,</span> <span class="s2">&quot;NONE&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">ls</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="m3_correction.utc2lstmoon" class="doc doc-heading">
<code class="highlight language-python"><span class="n">utc2lstmoon</span><span class="p">(</span><span class="n">utc</span><span class="p">,</span> <span class="n">lon</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Return lunar local solar time at utc [yyyy-mm-ddThh:mm:ss] and lon [deg].
Uses spiceypy. Moon is NAIF ID 301.</p>

          <details class="quote">
            <summary>Source code in <code>roughness/m3_correction.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1171</span>
<span class="normal">1172</span>
<span class="normal">1173</span>
<span class="normal">1174</span>
<span class="normal">1175</span>
<span class="normal">1176</span>
<span class="normal">1177</span>
<span class="normal">1178</span>
<span class="normal">1179</span>
<span class="normal">1180</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">utc2lstmoon</span><span class="p">(</span><span class="n">utc</span><span class="p">,</span> <span class="n">lon</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return lunar local solar time at utc [yyyy-mm-ddThh:mm:ss] and lon [deg].</span>
<span class="sd">    Uses spiceypy. Moon is NAIF ID 301.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">spiceypy</span><span class="o">.</span><span class="n">ktotal</span><span class="p">(</span><span class="s2">&quot;ALL&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">furnsh_kernels</span><span class="p">()</span>
    <span class="n">et</span> <span class="o">=</span> <span class="n">spiceypy</span><span class="o">.</span><span class="n">str2et</span><span class="p">(</span><span class="n">utc</span><span class="p">)</span>
    <span class="n">lst</span> <span class="o">=</span> <span class="n">spiceypy</span><span class="o">.</span><span class="n">spiceypy</span><span class="o">.</span><span class="n">et2lst</span><span class="p">(</span><span class="n">et</span><span class="p">,</span> <span class="mi">301</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">lon</span><span class="p">),</span> <span class="s2">&quot;PLANETOGRAPHIC&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">lst</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="m3_correction.utc2sdistmoon" class="doc doc-heading">
<code class="highlight language-python"><span class="n">utc2sdistmoon</span><span class="p">(</span><span class="n">utc</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Return solar distance [AU] from utc date using spiceypy.</p>

          <details class="quote">
            <summary>Source code in <code>roughness/m3_correction.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1196</span>
<span class="normal">1197</span>
<span class="normal">1198</span>
<span class="normal">1199</span>
<span class="normal">1200</span>
<span class="normal">1201</span>
<span class="normal">1202</span>
<span class="normal">1203</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">utc2sdistmoon</span><span class="p">(</span><span class="n">utc</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return solar distance [AU] from utc date using spiceypy.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">spiceypy</span><span class="o">.</span><span class="n">ktotal</span><span class="p">(</span><span class="s2">&quot;ALL&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">furnsh_kernels</span><span class="p">()</span>
    <span class="n">et</span> <span class="o">=</span> <span class="n">spiceypy</span><span class="o">.</span><span class="n">utc2et</span><span class="p">(</span><span class="n">utc</span><span class="p">)</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="n">spiceypy</span><span class="o">.</span><span class="n">spkpos</span><span class="p">(</span><span class="s2">&quot;SUN&quot;</span><span class="p">,</span> <span class="n">et</span><span class="p">,</span> <span class="s2">&quot;J2000&quot;</span><span class="p">,</span> <span class="s2">&quot;NONE&quot;</span><span class="p">,</span> <span class="s2">&quot;MOON&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">sdist</span> <span class="o">=</span> <span class="n">spiceypy</span><span class="o">.</span><span class="n">convrt</span><span class="p">(</span><span class="n">spiceypy</span><span class="o">.</span><span class="n">vnorm</span><span class="p">(</span><span class="n">pos</span><span class="p">),</span> <span class="s2">&quot;KM&quot;</span><span class="p">,</span> <span class="s2">&quot;AU&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sdist</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="m3_correction.wl_to_ind" class="doc doc-heading">
<code class="highlight language-python"><span class="n">wl_to_ind</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wavelengths</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Return index of wl in wavelengths.</p>

          <details class="quote">
            <summary>Source code in <code>roughness/m3_correction.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1275</span>
<span class="normal">1276</span>
<span class="normal">1277</span>
<span class="normal">1278</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">wl_to_ind</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wavelengths</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return index of wl in wavelengths.&quot;&quot;&quot;</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">wavelengths</span><span class="p">)</span> <span class="o">-</span> <span class="n">wl</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">ind</span><span class="p">,</span> <span class="n">wavelengths</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="m3_correction.xy2np" class="doc doc-heading">
<code class="highlight language-python"><span class="n">xy2np</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Swap axes from [x, y, (bands)] to [rows, columns, (bands)].</p>

          <details class="quote">
            <summary>Source code in <code>roughness/m3_correction.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1266</span>
<span class="normal">1267</span>
<span class="normal">1268</span>
<span class="normal">1269</span>
<span class="normal">1270</span>
<span class="normal">1271</span>
<span class="normal">1272</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">xy2np</span><span class="p">(</span><span class="n">arr</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Swap axes from [x, y, (bands)] to [rows, columns, (bands)].&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">arr</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2023 Christian Tai Udovicic
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
    <a href="https://github.com/nau-pixel" target="_blank" rel="noopener" title="NAU-PIXEL on GitHub" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.instant", "navigation.tabs"], "search": "../../assets/javascripts/workers/search.dfff1995.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.78eede0e.min.js"></script>
      
        <script src="../../docs/javascript/config.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>